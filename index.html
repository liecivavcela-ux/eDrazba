<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Dražba</title> 
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --google-blue: #1a73e8; --google-blue-hover: #1765cc; 
            --background-color: #f8f9fa; --surface-color: #ffffff; 
            --text-primary: #202124; --text-secondary: #5f6368; 
            --border-color: #dadce0; --error-color: #d93025; 
        }
        body { 
            font-family: 'Roboto', sans-serif; background-color: var(--background-color); color: var(--text-primary); 
            display: flex; justify-content: center; align-items: center; 
            padding: 24px; min-height: 100vh;
            flex-direction: column; 
        }
        
        #role-selection {
            display: flex; flex-direction: column; align-items: center; text-align: center;
            background-color: var(--surface-color); border-radius: 8px; padding: 40px;
            box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
            width: 100%; max-width: 500px; box-sizing: border-box;
        }
        #role-selection h1 { font-size: 28px; font-weight: 500; margin: 0 0 16px 0; }
        #role-selection p { font-size: 16px; color: var(--text-secondary); margin: 0 0 32px 0; max-width: 400px; }
        .role-buttons { display: flex; flex-direction: column; gap: 16px; width: 100%; max-width: 300px; }
        .role-buttons button { width: 100%; padding: 16px; font-size: 16px; }

        #navrhovatel-view, #zaujemca-view, #detail-view, #bidder-login-view {
            display: none; width: 100%; max-width: 800px; 
            align-self: flex-start; margin-top: 0; 
        }
        #bidder-login-view { 
            max-width: 500px; 
            align-self: center; 
            margin-top: 50px;
        } 
        
        .view-header { display: flex; justify-content: flex-end; margin-bottom: 16px; width: 100%; }
        .view-header button { width: auto; }

        .panel { 
            background-color: var(--surface-color); border-radius: 8px; border: 1px solid var(--border-color); 
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15); 
            padding: 24px; width: 100%; box-sizing: border-box; 
        }
        
        h2 { font-size: 22px; font-weight: 500; margin-top: 0; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 16px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin: 0; }
        .form-group-full { grid-column: 1 / -1; } 
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: var(--text-secondary); }
        label a.address-map-link { font-size: 12px; margin-left: 8px; float: right; } 
        input, select, textarea { width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        textarea { resize: vertical; min-height: 100px; }
        input[type="datetime-local"] { font-family: sans-serif; } 
        
        button { padding: 12px; font-size: 14px; font-weight: 500; border-radius: 8px; cursor: pointer; border: none; }
        button:disabled { background-color: #f1f3f4; color: #bdc1c6; cursor: not-allowed; }
        .btn-primary { background-color: var(--google-blue); color: white; width: 100%; } .btn-primary:not(:disabled):hover { background-color: var(--google-blue-hover); }
        .btn-secondary { background-color: var(--surface-color); color: var(--google-blue); border: 1px solid var(--border-color); width: auto; } .btn-secondary:not(:disabled):hover { background-color: #f8f9fa; }

        #drazby-list { display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 16px; }
        .drazba-item { background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; overflow: hidden; }
        .drazba-item h3 { margin: 0 0 12px 0; color: var(--google-blue); font-size: 18px; }
        .drazba-item-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; font-size: 14px; }
        .drazba-item-grid p { margin: 4px 0; }
        .drazba-item-grid p strong { color: var(--text-primary); }
        .drazba-item-full { grid-column: 1 / -1; }
        .drazba-item .btn-primary { width: auto; padding: 8px 16px; margin-top: 16px; }

        .drazba-item-image {
            width: 100%; height: 250px; object-fit: cover; 
            border-radius: 8px; margin-bottom: 16px; 
        }

        .detail-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 24px; margin-bottom: 24px;
        }
        .detail-image {
            width: 100%; border-radius: 8px; object-fit: cover;
        }
        .detail-info h2 {
            border: none; padding-bottom: 8px; margin-bottom: 16px;
        }
        .detail-info p {
            font-size: 16px; margin: 8px 0; color: var(--text-secondary);
        }
        .detail-info p strong {
            color: var(--text-primary);
        }
        .current-price {
            font-size: 28px; font-weight: 500; color: var(--google-blue);
            display: block; margin-top: 16px;
        }
        .bid-form-grid {
            display: grid; grid-template-columns: 1fr auto;
            gap: 16px; align-items: flex-end;
        }
        #bid-history-list {
            list-style-type: none; padding-left: 0; margin-top: 16px;
            max-height: 200px; overflow-y: auto;
            border-top: 1px solid var(--border-color);
        }
        #bid-history-list li {
            padding: 12px 0; border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }
         /* ===== NOVÝ ŠTÝL PRE TLAČIDLO ZMENY ID ===== */
        #changeBidderIdButton {
             font-size: 12px;
             color: var(--text-secondary);
             text-decoration: underline;
             cursor: pointer;
             background: none;
             border: none;
             padding: 0;
             margin-top: 8px;
         }

         @media (max-width: 600px) { 
              body { padding: 8px; gap: 8px;}
              #role-selection, #bidder-login-view { 
                  padding: 20px; margin-top: 20px;
              }
              #role-selection h1 { font-size: 24px;}
              .role-buttons { flex-direction: column; width: 100%;} 
              .role-buttons button { width: 100%; }
              .panel { padding: 12px; } 
              h2 { font-size: 18px; }
              .form-grid, .drazba-item-grid { grid-template-columns: 1fr; }
              .form-group-full { grid-column: 1; }
              .detail-grid { grid-template-columns: 1fr; } 
         }
    </style>
</head>
<body>

    <div id="role-selection">
        <h1>Vitajte v E-Dražbe</h1>
        <p>Ste tu, aby ste navrhli novú dražbu, alebo sa chcete zúčastniť ako záujemca?</p>
        <div class="role-buttons">
            <button class="btn-primary" onclick="showNavrhovatelView()">Som Navrhovateľ</button>
            <button class="btn-primary" onclick="showZaujemcaView()">Som Záujemca (kupujúci)</button>
        </div>
    </div>

    <div id="navrhovatel-view">
         <div class="view-header">
             <button class="btn-secondary" onclick="showRoleSelection()">Zmeniť rolu</button>
         </div>
         <div class="panel">
             <h2>Navrhnúť novú dražbu</h2>
             <form id="drazba-form" onsubmit="handleDrazbaSubmit(event)">
                 <div class="form-grid">
                     <div class="form-group"> <label for="navrhovatel">Navrhovateľ:</label> <select id="navrhovatel" required> <option value="">-- Vyberte rolu --</option> <option value="Vlastník">Vlastník</option> <option value="Dražobník">Dražobník</option> <option value="Exekútor">Exekútor</option> <option value="Správca">Správca</option> </select> </div>
                     <div class="form-group"> <label for="typNehnutelnosti">Typ nehnuteľnosti:</label> <select id="typNehnutelnosti" required> <option value="">-- Vyberte typ --</option> <option value="Garzónka">Garzónka</option> <option value="1-izbový byt">1-izbový byt</option> <option value="2-izbový byt">2-izbový byt</option> <option value="3-izbový byt">3-izbový byt</option> <option value="4-izbový byt">4-izbový byt</option> <option value="Rodinný dom">Rodinný dom</option> <option value="Garáž">Garáž</option> <option value="Záhrada">Záhrada</option> <option value="Stavebný pozemok">Stavebný pozemok</option> <option value="Komerčný objekt">Komerčný objekt</option> <option value="Iné">Iné</option> </select> </div>
                     <div class="form-group"> <label for="okres">Okres:</label> <select id="okres" required onchange="updateMapLink()"> <option value="">-- Vyberte okres --</option> <option value="Bánovce nad Bebravou">Bánovce nad Bebravou</option><option value="Banská Bystrica">Banská Bystrica</option><option value="Banská Štiavnica">Banská Štiavnica</option><option value="Bardejov">Bardejov</option><option value="Bratislava I">Bratislava I</option><option value="Bratislava II">Bratislava II</option><option value="Bratislava III">Bratislava III</option><option value="Bratislava IV">Bratislava IV</option><option value="Bratislava V">Bratislava V</option><option value="Brezno">Brezno</option><option value="Bytča">Bytča</option><option value="Čadca">Čadca</option><option value="Detva">Detva</option><option value="Dolný Kubín">Dolný Kubín</option><option value="Dunajská Streda">Dunajská Streda</option><option value="Galanta">Galanta</option><option value="Gelnica">Gelnica</option><option value="Hlohovec">Hlohovec</option><option value="Humenné">Humenné</option><option value="Ilava">Ilava</option><option value="Kežmarok">Kežmarok</option><option value="Komárno">Komárno</option><option value="Košice I">Košice I</option><option value="Košice II">Košice II</option><option value="Košice III">Košice III</option><option value="Košice IV">Košice IV</option><option value="Košice-okolie">Košice-okolie</option><option value="Krupina">Krupina</option><option value="Kysucké Nové Mesto">Kysucké Nové Mesto</option><option value="Levice">Levice</option><option value="Levoča">Levoča</option><option value="Liptovský Mikuláš">Liptovský Mikuláš</option><option value="Lučenec">Lučenec</option><option value="Malacky">Malacky</option><option value="Martin">Martin</option><option value="Medzilaborce">Medzilaborce</option><option value="Michalovce">Michalovce</option><option value="Myjava">Myjava</option><option value="Námestovo">Námestovo</option><option value="Nitra">Nitra</option><option value="Nové Mesto nad Váhom">Nové Mesto nad Váhom</option><option value="Nové Zámky">Nové Zámky</option><option value="Partizánske">Partizánske</option><option value="Pezinok">Pezinok</option><option value="Piešťany">Piešťany</option><option value="Poltár">Poltár</option><option value="Poprad">Poprad</option><option value="Považská Bystrica">Považská Bystrica</option><option value="Prešov">Prešov</option><option value="Prievidza">Prievidza</option><option value="Púchov">Púchov</option><option value="Revúca">Revúca</option><option value="Rimavská Sobota">Rimavská Sobota</option><option value="Rožňava">Rožňava</option><option value="Ružomberok">Ružomberok</option><option value="Sabinov">Sabinov</option><option value="Senec">Senec</option><option value="Senica">Senica</option><option value="Skalica">Skalica</option><option value="Snina">Snina</option><option value="Sobrance">Sobrance</option><option value="Spišská Nová Ves">Spišská Nová Ves</option><option value="Stará Ľubovňa">Stará Ľubovňa</option><option value="Stropkov">Stropkov</option><option value="Svidník">Svidník</option><option value="Šaľa">Šaľa</option><option value="Topoľčany">Topoľčany</option><option value="Trebišov">Trebišov</option><option value="Trenčín">Trenčín</option><option value="Trnava">Trnava</option><option value="Turčianske Teplice">Turčianske Teplice</option><option value="Tvrdošín">Tvrdošín</option><option value="Veľký Krtíš">Veľký Krtíš</option><option value="Vranov nad Topľou">Vranov nad Topľou</option><option value="Zlaté Moravce">Zlaté Moravce</option><option value="Zvolen">Zvolen</option><option value="Žarnovica">Žarnovica</option><option value="Žiar nad Hronom">Žiar nad Hronom</option><option value="Žilina">Žilina</option> </select> </div>
                     <div class="form-group"> <label for="adresa">Adresa nehnuteľnosti: <a href="#" id="adresaMapLink" target="_blank" class="address-map-link" style="display: none;">(Zobrať na mape)</a> </label> <input type="text" id="adresa" placeholder="Napr. Hlavná 1, 91701 Trnava" required oninput="updateMapLink()"> </div>
                     <div class="form-group"> <label for="znalecnaCena">Znalcom určená cena (€):</label> <input type="number" id="znalecnaCena" placeholder="Napr. 150000" min="0" required> </div>
                     <div class="form-group"> <label for="najnizsiePodanie">Najnižšie podanie (€):</label> <input type="number" id="najnizsiePodanie" placeholder="Napr. 100000" min="0" required> </div>
                     <div class="form-group"> <label for="minimalnePrihodenie">Minimálne prihodenie (€):</label> <input type="number" id="minimalnePrihodenie" placeholder="Napr. 1000" min="1" required> </div>
                     <div class="form-group"> <label for="mobilNavrhovatela">Kontaktný mobil (10 číslic):</label> <input type="tel" id="mobilNavrhovatela" placeholder="09XX XXX XXX" required> </div>
                     <div class="form-group"> <label for="casZaciatku">Dátum a čas začatia dražby:</label> <input type="datetime-local" id="casZaciatku" required> </div>
                     <div class="form-group"> <label for="casSkoncenia">Dátum a čas skončenia dražby:</label> <input type="datetime-local" id="casSkoncenia" required> </div>
                     <div class="form-group form-group-full"> <label for="imageUrl">URL adresa obrázka (nepovinné):</label> <input type="url" id="imageUrl" placeholder="https://... (napr. adresa z Imgur)"> </div>
                     <div class="form-group form-group-full"> <label for="predmetDrazby">Predmet dražby (popis):</label> <textarea id="predmetDrazby" placeholder="Stručne popíšte predmet dražby..." required></textarea> </div>
                 </div>
                 <button type="submit" id="submitDrazbaButton" class="btn-primary" style="margin-top: 16px;">Vytvoriť dražbu</button>
             </form>
         </div>
    </div>

    <div id="zaujemca-view">
         <div class="view-header">
             <button class="btn-secondary" onclick="showRoleSelection()">Zmeniť rolu</button>
         </div>
         <div class="panel">
              <h2>Prehľad aktuálnych dražieb</h2>
              <div id="drazby-list">
                  <p>Načítavam zoznam dražieb...</p>
              </div>
              <div id="bidder-id-info" style="margin-top: 20px; font-size: 14px; color: var(--text-secondary); display: none;">
                  Prihadzujete ako: <strong id="currentBidderIdDisplay"></strong> 
                  <button id="changeBidderIdButton" onclick="clearBidderIdAndShowLogin()">Zmeniť</button>
              </div>
              </div>
    </div>

    <div id="bidder-login-view">
        <div class="panel">
            <h2>Identifikácia záujemcu</h2>
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 24px;"> Pre vstup do dražby zadajte prosím Vaše číslo dokladu totožnosti a mobilné číslo. Vaša identita zostane ostatným účastníkom skrytá. </p>
            <form id="bidder-login-form" onsubmit="handleBidderLoginSubmit(event)">
                <input type="hidden" id="loginAuctionId" value=""> 
                <div class="form-group" style="margin-bottom: 16px;"> <label for="bidderIdDoc">Číslo dokladu totožnosti (napr. OP):</label> <input type="text" id="bidderIdDoc" placeholder="Napr. EB123456" required> </div>
                <div class="form-group" style="margin-bottom: 16px;"> <label for="bidderMobile">Mobilné číslo (formát 09XX XXX XXX):</label> <input type="tel" id="bidderMobile" placeholder="09XX XXX XXX" pattern="09\d{2} \d{3} \d{3}" required title="Zadajte číslo v tvare 09XX XXX XXX"> </div>
                <div class="form-group" style="margin-bottom: 24px;"> <label for="bidderMaxBid">Moja maximálna ponuka (€) (nepovinné):</label> <input type="number" id="bidderMaxBid" placeholder="Zadajte Váš limit" min="0"> <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 4px;">Ak zadáte, systém bude automaticky prihadzovať za Vás až do tejto sumy.</small> </div>
                <button type="submit" id="bidderLoginSubmitButton" class="btn-primary">Vstúpiť do dražby</button> 
                <button type="button" class="btn-secondary" onclick="showZaujemcaView()" style="margin-top: 16px; width: 100%;">Zrušiť a späť na prehľad</button>
            </form>
        </div>
    </div>

    <div id="detail-view">
        <div class="view-header">
            <button class="btn-secondary" onclick="showZaujemcaView()">Späť na prehľad</button>
        </div>
        <div class="panel">
            <div id="detail-content"> <p>Načítavam detail dražby...</p> </div>
            <h2 style="margin-top: 24px;">Prihadzovanie</h2>
            <form id="bid-form" onsubmit="handleBidSubmit(event)" data-auction-id="">
                <div class="bid-form-grid">
                    <div class="form-group"> <label for="bidAmount">Vaša ponuka (€):</label> <input type="number" id="bidAmount" placeholder="Zadajte sumu" min="0" required> </div>
                    <button type="submit" class="btn-primary" style="width: auto;">Prihodiť</button>
                </div>
            </form>
            <h2 style="margin-top: 24px;">História prihodení</h2>
            <ul id="bid-history-list"> <li>Zatiaľ žiadne prihodenia.</li> </ul>
        </div>
    </div>

    
    <script>
        console.log("Kontrolný bod: E-Dražba Skript začal."); 
        
        const API_URL = 'https://e-drazba-server.onrender.com';
        
        let roleSelectionDiv, navrhovatelViewDiv, zaujemcaViewDiv, detailViewDiv, bidderLoginViewDiv, 
            drazbyListDiv, drazbaForm, adresaInput, okresSelect, adresaMapLink, imageUrlInput,
            bidderIdInfoDiv, currentBidderIdDisplay; // Pridané pre zobrazenie ID

        // --- Funkcie na prepínanie pohľadov ---
        function showRoleSelection() { 
            console.log("Zobrazujem výber role.");
            if (roleSelectionDiv) roleSelectionDiv.style.display = 'flex';
            if (navrhovatelViewDiv) navrhovatelViewDiv.style.display = 'none';
            if (zaujemcaViewDiv) zaujemcaViewDiv.style.display = 'none';
            if (detailViewDiv) detailViewDiv.style.display = 'none'; 
            if (bidderLoginViewDiv) bidderLoginViewDiv.style.display = 'none';
            document.body.style.alignItems = 'center'; 
        }
        function showNavrhovatelView() { 
             console.log("Zobrazujem pohľad Navrhovateľa.");
            if (roleSelectionDiv) roleSelectionDiv.style.display = 'none';
            if (navrhovatelViewDiv) navrhovatelViewDiv.style.display = 'block'; 
            if (zaujemcaViewDiv) zaujemcaViewDiv.style.display = 'none';
            if (detailViewDiv) detailViewDiv.style.display = 'none'; 
            if (bidderLoginViewDiv) bidderLoginViewDiv.style.display = 'none';
            document.body.style.alignItems = 'flex-start'; 
        }
         function showZaujemcaView() { 
              console.log("Zobrazujem pohľad Záujemcu.");
            if (roleSelectionDiv) roleSelectionDiv.style.display = 'none';
            if (navrhovatelViewDiv) navrhovatelViewDiv.style.display = 'none';
            if (zaujemcaViewDiv) zaujemcaViewDiv.style.display = 'block'; 
            if (detailViewDiv) detailViewDiv.style.display = 'none'; 
            if (bidderLoginViewDiv) bidderLoginViewDiv.style.display = 'none';
            document.body.style.alignItems = 'flex-start'; 
            
            // ===== ZMENA: Zobrazíme info o uloženom ID (ak existuje) =====
            displayBidderIdInfo(); 
            // ========================================================
            loadDrazby(); 
        }
        function showDetailView(auctionId) { 
            console.log(`Zobrazujem detail pre dražbu ID: ${auctionId}`);
            if (roleSelectionDiv) roleSelectionDiv.style.display = 'none';
            if (navrhovatelViewDiv) navrhovatelViewDiv.style.display = 'none';
            if (zaujemcaViewDiv) zaujemcaViewDiv.style.display = 'none';
            if (detailViewDiv) detailViewDiv.style.display = 'block'; 
            if (bidderLoginViewDiv) bidderLoginViewDiv.style.display = 'none';
            document.body.style.alignItems = 'flex-start';
            loadAuctionDetail(auctionId); 
        }
        
        // ===== UPRAVENÁ FUNKCIA: showBidderLogin =====
        function showBidderLogin(auctionId) {
            // ===== ZMENA: Skontrolujeme, či už máme ID v localStorage =====
            const existingBidderId = localStorage.getItem('currentBidderId');
            if (existingBidderId) {
                console.log(`Používateľ ${existingBidderId} už je identifikovaný, preskakujem login.`);
                // Ak ID existuje, rovno zobrazíme detail
                showDetailView(auctionId); 
                return; // Ukončíme funkciu tu
            }
            // =========================================================

            // Ak ID neexistuje, zobrazíme login formulár
            console.log(`Zobrazujem login formulár pre dražbu ID: ${auctionId}`);
            if (roleSelectionDiv) roleSelectionDiv.style.display = 'none';
            if (navrhovatelViewDiv) navrhovatelViewDiv.style.display = 'none';
            if (zaujemcaViewDiv) zaujemcaViewDiv.style.display = 'none';
            if (detailViewDiv) detailViewDiv.style.display = 'none'; 
            if (bidderLoginViewDiv) bidderLoginViewDiv.style.display = 'block'; 
            
            const loginAuctionIdInput = document.getElementById('loginAuctionId');
            if (loginAuctionIdInput) loginAuctionIdInput.value = auctionId;
             
            const docInput = document.getElementById('bidderIdDoc');
            const mobileInput = document.getElementById('bidderMobile');
            const maxBidInput = document.getElementById('bidderMaxBid');
            if(docInput) docInput.value = '';
            if(mobileInput) mobileInput.value = '';
            if(maxBidInput) maxBidInput.value = '';
            
            document.body.style.alignItems = 'center'; 
        }

        // ===== NOVÁ FUNKCIA: Zobrazenie informácie o aktuálnom Bidder ID =====
        function displayBidderIdInfo() {
            const bidderId = localStorage.getItem('currentBidderId');
            if (bidderIdInfoDiv && currentBidderIdDisplay) {
                if (bidderId) {
                    // Anonymizujeme ID pre zobrazenie
                    const displayId = bidderId.length > 4 ? `ID: ${bidderId.substring(0, 2)}...${bidderId.substring(bidderId.length - 4)}` : bidderId;
                    currentBidderIdDisplay.textContent = displayId;
                    bidderIdInfoDiv.style.display = 'block'; // Zobrazíme info blok
                } else {
                    bidderIdInfoDiv.style.display = 'none'; // Skryjeme info blok
                }
            }
        }
        
        // ===== NOVÁ FUNKCIA: Vymazanie Bidder ID a zobrazenie login formulára =====
        function clearBidderIdAndShowLogin() {
            if (confirm('Naozaj chcete zmeniť svoju identitu záujemcu? Budete musieť znova zadať údaje.')) {
                localStorage.removeItem('currentBidderId');
                console.log("Bidder ID vymazané z localStorage.");
                displayBidderIdInfo(); // Aktualizujeme zobrazenie (skryje sa)
                // Teraz by mal používateľ kliknúť na "Vstúpiť do dražby", aby sa zobrazil login formulár
                alert("Vaša identita bola odstránená. Pre vstup do dražby kliknite znova na 'Vstúpiť do dražby'.");
            }
        }
        // ====================================================================

        
        function updateMapLink() { /* ... */ }
        async function loadDrazby() { /* ... */ }
        async function loadAuctionDetail(auctionId) { /* ... */ }
        async function handleDrazbaSubmit(event) { /* ... */ }

        // ===== UPRAVENÁ FUNKCIA: Spracovanie formulára pre identifikáciu Záujemcu =====
        async function handleBidderLoginSubmit(event) { 
            event.preventDefault(); 
            console.log("Spracovávam bidder login...");

            const docIdInput = document.getElementById('bidderIdDoc');
            const mobileInput = document.getElementById('bidderMobile');
            const auctionIdInput = document.getElementById('loginAuctionId');
            const maxBidInput = document.getElementById('bidderMaxBid'); 
            const submitButton = document.getElementById('bidderLoginSubmitButton'); 

            const docId = docIdInput.value.trim().toUpperCase(); 
            const mobile = mobileInput.value.trim();
            const auctionId = auctionIdInput.value;
            const maxBidValue = maxBidInput.value.trim(); 
            let maxBid = maxBidValue ? Number(maxBidValue) : null; 

            if (!docId || !mobile || !auctionId) { alert("Prosím, vyplňte číslo dokladu a mobil."); return; }
            if (!/^09\d{2} \d{3} \d{3}$/.test(mobile)) { alert("Prosím, zadajte mobilné číslo v správnom tvare (09XX XXX XXX)."); mobileInput.focus(); return; }
            if (maxBid !== null && (isNaN(maxBid) || maxBid <= 0)) { alert("Prosím, zadajte platnú sumu pre maximálnu ponuku."); maxBidInput.focus(); return; }

            const anonymizedDocId = docId.length > 4 ? docId.substring(docId.length - 4) : docId;
            const anonymizedMobile = mobile.length > 3 ? mobile.substring(mobile.length - 3) : mobile;
            const bidderIdentifier = `ID-${anonymizedDocId}${anonymizedMobile}`;
            console.log(`Vygenerované Bidder ID: ${bidderIdentifier}`);

            submitButton.disabled = true;
            submitButton.textContent = 'Spracovávam...';

            try {
                // --- KROK 1: Uložíme si bidderId do localStorage ---
                localStorage.setItem('currentBidderId', bidderIdentifier); // ZMENA tu
                console.log("Bidder ID uložené do localStorage.");

                // --- KROK 2: Ak bol zadaný maxBid, pošleme ho na server ---
                if (maxBid !== null) {
                    console.log(`Odosielam nastavenie proxy bid: ${maxBid} pre ${bidderIdentifier}`);
                    const proxyResponse = await fetch(`${API_URL}/api/drazby/${auctionId}/setproxy`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ bidderId: bidderIdentifier, maxBid: maxBid })
                    });
                    if (!proxyResponse.ok) {
                        const errorData = await proxyResponse.json();
                        alert(`Chyba pri nastavovaní maximálnej ponuky: ${errorData.message}`); 
                        console.error('Chyba pri setproxy:', errorData.message);
                    } else {
                        const proxyResult = await proxyResponse.json();
                        console.log('Odpoveď zo setproxy:', proxyResult.message);
                    }
                }

                // --- KROK 3: Vždy zobrazíme detail dražby ---
                showDetailView(auctionId);

            } catch (error) {
                console.error("Chyba pri bidder login alebo setproxy:", error);
                alert(`Nastala chyba: ${error.message}`);
                // Odblokujeme tlačidlo len ak nastala chyba PRED zobrazením detailu
                submitButton.disabled = false;
                submitButton.textContent = 'Vstúpiť do dražby';
            } 
            // Poznámka: Ak všetko prejde OK, tlačidlo sa odblokuje automaticky pri návrate na inú obrazovku
        }


        async function handleBidSubmit(event) { 
            event.preventDefault(); 
            console.log("Pokus o prihodenie...");

            const form = event.target;
            const auctionId = form.dataset.auctionId; 
            const bidAmountInput = document.getElementById('bidAmount');
            const bidButton = form.querySelector('button[type="submit"]');

            const amount = Number(bidAmountInput.value);

            // ===== ZMENA: Načítame uložený bidderId z localStorage =====
            const bidderId = localStorage.getItem('currentBidderId'); 
            if (!bidderId) {
                alert("Chyba: Váš identifikátor sa nenašiel. Skúste sa vrátiť späť a znova zadať údaje.");
                showZaujemcaView(); // Vrátime ho na zoznam
                return; 
            }
            console.log(`Prihadzujem ako ${bidderId} sumu ${amount}`);
            // =======================================================

            bidButton.disabled = true;
            bidButton.textContent = 'Odosielam...';

            try {
                const response = await fetch(`${API_URL}/api/drazby/${auctionId}/bid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount, bidderId: bidderId }) 
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Neznáma chyba servera');
                }

                const updatedAuction = await response.json();
                console.log('Prihodenie úspešné:', updatedAuction);
                
                alert('Vaše prihodenie bolo úspešne prijaté!');

                loadAuctionDetail(auctionId); // Obnoví detail

            } catch (error) {
                console.error('Chyba pri prihadzovaní:', error);
                alert(`Chyba: ${error.message}`); 
            } finally {
                bidButton.disabled = false;
                bidButton.textContent = 'Prihodiť';
            }
        }

        // --- INICIALIZÁCIA APLIKÁCIE ---
        document.addEventListener('DOMContentLoaded', () => { 
             console.log("Kontrolný bod: DOM načítaný, inicializácia.");
             try {
                 roleSelectionDiv = document.getElementById('role-selection'); 
                 navrhovatelViewDiv = document.getElementById('navrhovatel-view'); 
                 zaujemcaViewDiv = document.getElementById('zaujemca-view'); 
                 detailViewDiv = document.getElementById('detail-view'); 
                 bidderLoginViewDiv = document.getElementById('bidder-login-view'); 
                 drazbyListDiv = document.getElementById('drazby-list'); 
                 drazbaForm = document.getElementById('drazba-form'); 
                 adresaInput = document.getElementById('adresa'); 
                 okresSelect = document.getElementById('okres'); 
                 adresaMapLink = document.getElementById('adresaMapLink'); 
                 imageUrlInput = document.getElementById('imageUrl');
                 // ===== Inicializácia nových elementov =====
                 bidderIdInfoDiv = document.getElementById('bidder-id-info');
                 currentBidderIdDisplay = document.getElementById('currentBidderIdDisplay');
                 // =======================================
                 
                 showRoleSelection(); 
                 
                 console.log("Kontrolný bod: Inicializácia dokončená.");
             } catch (error) { 
                 console.error("KRITICKÁ CHYBA počas inicializácie:", error); 
                 const body = document.querySelector('body'); 
                 if(body) body.innerHTML = `<p style="color:red;">Kritická chyba: ${error.message}</p>`; 
             }
        });
        
        console.log("Kontrolný bod: Skript načítaný.");
    </script>

</body>
</html>
