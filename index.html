<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Dražba (Diagnostika v2)</title> 
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style> /* --- CSS (zjednodušená verzia) --- */ :root{/*...*/} body{/*...*/} .container{/*...*/} .header{/*...*/} #drazby-list{/*...*/} .drazba-item{/*...*/} .drazba-item h3{/*...*/} .drazba-item p{/*...*/} .drazba-item .price-info{/*...*/} .drazba-item .current-price{/*...*/} .drazba-item .item-footer{/*...*/} .btn-delete{/*...*/} .modal-overlay{/*...*/} .modal-content{/*...*/} .modal-close-btn{/*...*/} .modal-content h2{/*...*/} .modal-content .form-grid{/*...*/} .modal-content .form-group{/*...*/} #bidder-login-modal .modal-content{/*...*/} .detail-info h2{/*...*/} .detail-info p{/*...*/} .detail-info .current-price{/*...*/} .bid-form-grid{/*...*/} #bid-history-list{/*...*/} .hidden{/*...*/} .visible{/*...*/} @media (max-width: 768px){/*...*/} .form-group-full{/*...*/} label a.address-map-link{/*...*/} input, select, textarea{/*...*/} textarea{/*...*/} input[type="datetime-local"]{/*...*/} button{/*...*/} button:disabled{/*...*/} .btn-primary{/*...*/} .btn-secondary{/*...*/} #changeBidderIdButton{/*...*/} </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>E-Dražba</h1><button class="btn-primary" onclick="openAddAuctionModal()">Pridať novú dražbu</button></div>
        <div id="drazby-list"><p>Inicializujem...</p></div>
        <div id="bidder-id-info" style="display: none; text-align: right;"></div>
    </div>
    <div id="addAuctionModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'addAuctionModal')"></div>
    <div id="bidderLoginModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'bidderLoginModal')"></div>
    <div id="auctionDetailModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'auctionDetailModal')"></div>
    
    <script>
        console.log("Skript začal.");
        window.onerror = function(msg, src, line, col, err) { console.error("NEZACHYTENÁ CHYBA:", msg, "@", src, `${line}:${col}`, err); document.body.innerHTML = `<p style="color:red;">CHYBA JS: ${msg}</p>`; return true; };
        console.log("Error handler OK.");
        const API_URL = 'https://e-drazba-server.onrender.com';
        let drazbyListDiv, drazbaForm, adresaInput, okresSelect, adresaMapLink, addAuctionModal, bidderLoginModal, auctionDetailModal, bidderIdInfoDiv, currentBidderIdDisplay; 
        
        // --- Ovládanie Modálov (bez zmien) ---
        function openModal(modalId) { /* ... */ } function closeModal(modalId) { /* ... */ } function closeModalOnClickOutside(event, modalId) { /* ... */ } function openAddAuctionModal() { /* ... */ } function openBidderLoginModal(auctionId) { /* ... */ } function openAuctionDetailModal(auctionId) { /* ... */ } function displayBidderIdInfo() { /* ... */ } function clearBidderIdAndShowLogin() { /* ... */ } function updateMapLink() { /* ... */ }

        // ===== VYLEPŠENÁ FUNKCIA: loadDrazby =====
        async function loadDrazby() { 
             console.log("--- loadDrazby: ZAČIATOK ---"); 
             drazbyListDiv = document.getElementById('drazby-list'); // Nájdeme element znova pre istotu
             if (!drazbyListDiv) return console.error("loadDrazby: Chýba drazbyListDiv!"); 
             drazbyListDiv.innerHTML = '<p>Načítavam zoznam dražieb...</p>'; 
             let drazby = []; // Inicializujeme ako prázdne pole

             try { 
                 console.log("  Posielam fetch...");
                 const response = await fetch(`${API_URL}/api/drazby`); 
                 console.log("  Fetch status:", response.status);
                 if (!response.ok) throw new Error(`Server ${response.status}`); 
                 
                 console.log("  Spracovávam JSON...");
                 drazby = await response.json(); 
                 console.log("  JSON OK, počet:", drazby.length);
                 
                 if (!drazbyListDiv) return console.error("loadDrazby: drazbyListDiv zmizol počas fetch!"); 
                 drazbyListDiv.innerHTML = ''; // Vyčistíme až teraz
                 
                 if (!Array.isArray(drazby)) throw new Error("Dáta nie sú pole."); 
                 if (drazby.length === 0) { drazbyListDiv.innerHTML = '<p>Žiadne dražby.</p>'; console.log("--- loadDrazby: KONIEC (žiadne dražby) ---"); return; } 

                 console.log("  Začínam FOR EACH cyklus...");
                 drazby.forEach((d, index) => { 
                     console.log(`    Spracovávam položku #${index}, ID: ${d ? d._id : '???'}`);
                     let itemHTML = ''; // Pripravíme HTML pre položku
                     try { 
                         if (!d || !d._id) throw new Error("Chýbajú dáta alebo ID"); 
                         
                         // Bezpečné načítanie hodnôt s defaultmi
                         const predmet = d.predmetDrazby || 'Neznámy predmet';
                         const adresa = d.adresa || 'N/A';
                         const okres = d.okres || 'N/A';
                         const opts = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }; 
                         const start = d.casZaciatku ? new Date(d.casZaciatku).toLocaleString('sk-SK', opts) : 'N/A'; 
                         const end = d.casSkoncenia ? new Date(d.casSkoncenia).toLocaleString('sk-SK', opts) : 'N/A'; 
                         const currentPriceRaw = typeof d.currentPrice === 'number' ? d.currentPrice : (typeof d.najnizsiePodanie === 'number' ? d.najnizsiePodanie : 0);
                         const startPriceRaw = typeof d.najnizsiePodanie === 'number' ? d.najnizsiePodanie : 0;
                         const cPrice = currentPriceRaw.toLocaleString('sk-SK'); 
                         const sPrice = startPriceRaw.toLocaleString('sk-SK'); 
                         
                         console.log(`      ID: ${d._id}, Predmet: ${predmet}, Cena: ${cPrice}`); // Logujeme dáta
                         
                         itemHTML = ` 
                             <h3>${predmet}</h3> 
                             <p><strong>Adresa:</strong> ${adresa}, ${okres}</p> 
                             <p><strong>Začiatok:</strong> ${start}</p> 
                             <p><strong>Koniec:</strong> ${end}</p> 
                             <div class="price-info"> 
                                 <p><strong>Aktuálna cena:</strong> <span class="current-price">${cPrice} €</span></p> 
                                 <p><strong>Najnižšie podanie:</strong> ${sPrice} €</p> 
                             </div> 
                             <div class="item-footer"> 
                                 <button class="btn-primary" onclick="openBidderLoginModal('${d._id}')">Vstúpiť / Prihodiť</button> 
                                 <button class="btn-delete" onclick="handleDeleteAuction('${d._id}')">Zmazať</button> 
                             </div>`; 
                         
                         const item = document.createElement('div'); 
                         item.className = 'drazba-item'; 
                         item.innerHTML = itemHTML; 
                         
                         // Až teraz pridáme do DOMu
                         if (drazbyListDiv) {
                              drazbyListDiv.appendChild(item); 
                              console.log(`      Položka #${index} pridaná do DOM.`);
                         } else {
                              console.error(`      Chyba: drazbyListDiv zmizol pred pridaním položky #${index}!`);
                         }
                         
                     } catch (loopErr) { 
                         console.error(`    CHYBA pri spracovaní položky #${index} (ID: ${d?d._id:'N/A'}):`, loopErr.message); 
                         // Vytvoríme chybovú kartu
                         const errItem = document.createElement('div'); 
                         errItem.className = 'drazba-item'; 
                         errItem.innerHTML = `<p style="color:red;">Chyba pri načítaní<br>ID: ${d?d._id:'N/A'}<br>${loopErr.message}</p>`; 
                         if (drazbyListDiv) drazbyListDiv.appendChild(errItem);
                     } 
                 }); 
                 console.log("  FOR EACH cyklus dokončený.");
             } catch (error) { 
                 console.error("KRITICKÁ CHYBA v loadDrazby:", error); 
                 if (drazbyListDiv) { drazbyListDiv.innerHTML = `<p style="color: red;">Chyba načítania: ${error.message}</p>`; } 
             } finally {
                 console.log("--- loadDrazby: KONIEC ---");
             }
        } 
        
        // --- Ostatné async funkcie (ponechané pre úplnosť, skrátené) ---
        async function loadAuctionDetail(auctionId) { /* ... implementácia ... */ }
        async function handleDrazbaSubmit(event) { /* ... implementácia ... */ }
        async function handleBidderLoginSubmit(event) { /* ... implementácia ... */ }
        async function handleBidSubmit(event) { /* ... implementácia ... */ } 
        async function handleDeleteAuction(auctionId) { /* ... implementácia ... */ }
        
        // --- INICIALIZÁCIA ---
        document.addEventListener('DOMContentLoaded', () => { 
             console.log("DOM načítaný."); 
             try { 
                 console.log("  Inicializujem..."); 
                 addAuctionModal = document.getElementById('addAuctionModal'); 
                 bidderLoginModal = document.getElementById('bidderLoginModal'); 
                 auctionDetailModal = document.getElementById('auctionDetailModal'); 
                 drazbyListDiv = document.getElementById('drazby-list'); 
                 drazbaForm = document.getElementById('drazba-form'); 
                 bidderIdInfoDiv = document.getElementById('bidder-id-info');
                 currentBidderIdDisplay = document.getElementById('currentBidderIdDisplay');
                 if (!addAuctionModal || !bidderLoginModal || !auctionDetailModal || !drazbyListDiv || !drazbaForm) throw new Error("Chýbajú kľúčové HTML elementy!");
                 console.log("  Elementy OK.");
                 console.log("  Volám displayBidderIdInfo...");
                 displayBidderIdInfo(); 
                 console.log("  Volám loadDrazby...");
                 loadDrazby(); 
                 console.log("Inicializácia OK."); 
             } catch (error) { 
                 console.error("KRITICKÁ CHYBA INIT:", error); 
                 document.body.innerHTML = `<p style="color:red;">Chyba inicializácie: ${error.message}</p>`; 
             } 
        }); 
        console.log("Skript načítaný.");
    </script>
</body>
</html>
