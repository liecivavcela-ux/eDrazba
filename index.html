<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Dražba (Jedna Stránka)</title> 
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS Štýly (zostávajú rovnaké) --- */
        :root { --google-blue: #1a73e8; --google-blue-hover: #1765cc; --background-color: #f8f9fa; --surface-color: #ffffff; --text-primary: #202124; --text-secondary: #5f6368; --border-color: #dadce0; --error-color: #d93025; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--background-color); color: var(--text-primary); margin: 0; padding: 24px; box-sizing: border-box; }
        .container { width: 100%; max-width: 900px; margin: 20px auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .header h1 { font-size: 28px; font-weight: 500; margin: 0; }
        #drazby-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; } 
        .drazba-item { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; overflow: hidden; box-shadow: 0 1px 2px rgba(60,64,67,0.3); display: flex; flex-direction: column; }
        .drazba-item img.drazba-item-image { width: 100%; height: 180px; object-fit: cover; border-radius: 4px; margin-bottom: 12px; background-color: #eee; } 
        .drazba-item h3 { margin: 0 0 8px 0; color: var(--google-blue); font-size: 18px; font-weight: 500; }
        .drazba-item p { font-size: 14px; color: var(--text-secondary); margin: 4px 0; }
        .drazba-item p strong { color: var(--text-primary); }
        .drazba-item .price-info { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); }
        .drazba-item .current-price { font-weight: 500; color: var(--google-blue); font-size: 16px; }
        .drazba-item .item-footer { margin-top: auto; display: flex; gap: 8px; padding-top: 16px; }
        .drazba-item .btn-primary { width: 100%; } 
        .btn-delete { background-color: var(--error-color); color: white; font-size: 12px; padding: 6px 10px; width: auto; } .btn-delete:hover { background-color: #c5221f; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .modal-content { background-color: var(--surface-color); border-radius: 8px; padding: 32px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); width: 100%; max-width: 700px; position: relative; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer; line-height: 1; }
        .modal-content h2 { margin-top: 0; font-size: 24px; }
        .modal-content .form-grid { grid-template-columns: 1fr 1fr; }
        .modal-content .form-group { margin-bottom: 16px; }
        #bidder-login-modal .modal-content { max-width: 500px; } 
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        .detail-image { width: 100%; border-radius: 8px; object-fit: cover; max-height: 400px; }
        .detail-info h2 { border: none; padding-bottom: 8px; margin-bottom: 16px; font-size: 22px; }
        .detail-info p { font-size: 16px; margin: 8px 0; color: var(--text-secondary); }
        .detail-info p strong { color: var(--text-primary); }
        .detail-info .current-price { font-size: 28px; font-weight: 500; color: var(--google-blue); display: block; margin-top: 16px; }
        .bid-form-grid { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: flex-end; }
        #bid-history-list { list-style-type: none; padding-left: 0; margin-top: 16px; max-height: 200px; overflow-y: auto; border-top: 1px solid var(--border-color); }
        #bid-history-list li { padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        .hidden { display: none !important; } 
        .visible { display: flex !important; } 
        @media (max-width: 768px) { .header { flex-direction: column; align-items: flex-start; gap: 10px;} #drazby-list { grid-template-columns: 1fr; } .modal-content { padding: 24px; } .modal-content .form-grid { grid-template-columns: 1fr; } .detail-grid { grid-template-columns: 1fr; } }
        /* --- Ostatné CSS --- */
        .form-group-full { grid-column: 1 / -1; } label a.address-map-link { font-size: 12px; margin-left: 8px; float: right; } input, select, textarea { width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; box-sizing: border-box; font-family: 'Roboto', sans-serif; } textarea { resize: vertical; min-height: 100px; } input[type="datetime-local"] { font-family: sans-serif; } button { padding: 12px; font-size: 14px; font-weight: 500; border-radius: 8px; cursor: pointer; border: none; } button:disabled { background-color: #f1f3f4; color: #bdc1c6; cursor: not-allowed; } .btn-primary { background-color: var(--google-blue); color: white; width: 100%; } .btn-primary:not(:disabled):hover { background-color: var(--google-blue-hover); } .btn-secondary { background-color: var(--surface-color); color: var(--google-blue); border: 1px solid var(--border-color); width: auto; } .btn-secondary:not(:disabled):hover { background-color: #f8f9fa; } #changeBidderIdButton { font-size: 12px; color: var(--text-secondary); text-decoration: underline; cursor: pointer; background: none; border: none; padding: 0; margin-top: 8px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>E-Dražba</h1>
            <button class="btn-primary" onclick="openAddAuctionModal()">Pridať novú dražbu</button>
        </div>
        <div id="drazby-list"> <p>Načítavam zoznam dražieb...</p> </div>
        <div id="bidder-id-info" style="margin-top: 20px; font-size: 14px; color: var(--text-secondary); display: none; text-align: right;"> Prihadzujete ako: <strong id="currentBidderIdDisplay"></strong> <button id="changeBidderIdButton" onclick="clearBidderIdAndShowLogin()">Zmeniť</button> </div>
    </div>

    <div id="addAuctionModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'addAuctionModal')">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('addAuctionModal')">&times;</button>
            <h2>Navrhnúť novú dražbu</h2>
            <form id="drazba-form" onsubmit="handleDrazbaSubmit(event)">
                 <div class="form-grid">
                     <div class="form-group"> <label for="navrhovatel">Navrhovateľ:</label> <select id="navrhovatel" required> <option value="">-- Vyberte rolu --</option> <option value="Vlastník">Vlastník</option> <option value="Dražobník">Dražobník</option> <option value="Exekútor">Exekútor</option> <option value="Správca">Správca</option> </select> </div>
                     <div class="form-group"> <label for="typNehnutelnosti">Typ nehnuteľnosti:</label> <select id="typNehnutelnosti" required> <option value="">-- Vyberte typ --</option> <option value="Garzónka">Garzónka</option> <option value="1-izbový byt">1-izbový byt</option> <option value="2-izbový byt">2-izbový byt</option> <option value="3-izbový byt">3-izbový byt</option> <option value="4-izbový byt">4-izbový byt</option> <option value="Rodinný dom">Rodinný dom</option> <option value="Garáž">Garáž</option> <option value="Záhrada">Záhrada</option> <option value="Stavebný pozemok">Stavebný pozemok</option> <option value="Komerčný objekt">Komerčný objekt</option> <option value="Iné">Iné</option> </select> </div>
                     
                     <div class="form-group">
                         <label for="okres">Okres:</label>
                         <select id="okres" required onchange="updateMapLink()">
                             <option value="">-- Vyberte okres --</option>
                             <option value="Bánovce nad Bebravou">Bánovce nad Bebravou</option><option value="Banská Bystrica">Banská Bystrica</option><option value="Banská Štiavnica">Banská Štiavnica</option><option value="Bardejov">Bardejov</option><option value="Bratislava I">Bratislava I</option><option value="Bratislava II">Bratislava II</option><option value="Bratislava III">Bratislava III</option><option value="Bratislava IV">Bratislava IV</option><option value="Bratislava V">Bratislava V</option><option value="Brezno">Brezno</option><option value="Bytča">Bytča</option><option value="Čadca">Čadca</option><option value="Detva">Detva</option><option value="Dolný Kubín">Dolný Kubín</option><option value="Dunajská Streda">Dunajská Streda</option><option value="Galanta">Galanta</option><option value="Gelnica">Gelnica</option><option value="Hlohovec">Hlohovec</option><option value="Humenné">Humenné</option><option value="Ilava">Ilava</option><option value="Kežmarok">Kežmarok</option><option value="Komárno">Komárno</option><option value="Košice I">Košice I</option><option value="Košice II">Košice II</option><option value="Košice III">Košice III</option><option value="Košice IV">Košice IV</option><option value="Košice-okolie">Košice-okolie</option><option value="Krupina">Krupina</option><option value="Kysucké Nové Mesto">Kysucké Nové Mesto</option><option value="Levice">Levice</option><option value="Levoča">Levoča</option><option value="Liptovský Mikuláš">Liptovský Mikuláš</option><option value="Lučenec">Lučenec</option><option value="Malacky">Malacky</option><option value="Martin">Martin</option><option value="Medzilaborce">Medzilaborce</option><option value="Michalovce">Michalovce</option><option value="Myjava">Myjava</option><option value="Námestovo">Námestovo</option><option value="Nitra">Nitra</option><option value="Nové Mesto nad Váhom">Nové Mesto nad Váhom</option><option value="Nové Zámky">Nové Zámky</option><option value="Partizánske">Partizánske</option><option value="Pezinok">Pezinok</option><option value="Piešťany">Piešťany</option><option value="Poltár">Poltár</option><option value="Poprad">Poprad</option><option value="Považská Bystrica">Považská Bystrica</option><option value="Prešov">Prešov</option><option value="Prievidza">Prievidza</option><option value="Púchov">Púchov</option><option value="Revúca">Revúca</option><option value="Rimavská Sobota">Rimavská Sobota</option><option value="Rožňava">Rožňava</option><option value="Ružomberok">Ružomberok</option><option value="Sabinov">Sabinov</option><option value="Senec">Senec</option><option value="Senica">Senica</option><option value="Skalica">Skalica</option><option value="Snina">Snina</option><option value="Sobrance">Sobrance</option><option value="Spišská Nová Ves">Spišská Nová Ves</option><option value="Stará Ľubovňa">Stará Ľubovňa</option><option value="Stropkov">Stropkov</option><option value="Svidník">Svidník</option><option value="Šaľa">Šaľa</option><option value="Topoľčany">Topoľčany</option><option value="Trebišov">Trebišov</option><option value="Trenčín">Trenčín</option><option value="Trnava">Trnava</option><option value="Turčianske Teplice">Turčianske Teplice</option><option value="Tvrdošín">Tvrdošín</option><option value="Veľký Krtíš">Veľký Krtíš</option><option value="Vranov nad Topľou">Vranov nad Topľou</option><option value="Zlaté Moravce">Zlaté Moravce</option><option value="Zvolen">Zvolen</option><option value="Žarnovica">Žarnovica</option><option value="Žiar nad Hronom">Žiar nad Hronom</option><option value="Žilina">Žilina</option>
                         </select>
                     </div>
                     <div class="form-group"> <label for="adresa">Adresa nehnuteľnosti: <a href="#" id="adresaMapLink" target="_blank" class="address-map-link" style="display: none;">(Zobrať na mape)</a> </label> <input type="text" id="adresa" placeholder="Napr. Hlavná 1, 91701 Trnava" required oninput="updateMapLink()"> </div>
                     <div class="form-group"> <label for="znalecnaCena">Znalcom určená cena (€):</label> <input type="number" id="znalecnaCena" placeholder="Napr. 150000" min="0" required> </div>
                     <div class="form-group"> <label for="najnizsiePodanie">Najnižšie podanie (€):</label> <input type="number" id="najnizsiePodanie" placeholder="Napr. 100000" min="0" required> </div>
                     <div class="form-group"> <label for="minimalnePrihodenie">Minimálne prihodenie (€):</label> <input type="number" id="minimalnePrihodenie" placeholder="Napr. 1000" min="1" required> </div>
                     <div class="form-group"> <label for="mobilNavrhovatela">Kontaktný mobil (10 číslic):</label> <input type="tel" id="mobilNavrhovatela" placeholder="09XX XXX XXX" required> </div>
                     <div class="form-group"> <label for="casZaciatku">Dátum a čas začatia dražby:</label> <input type="datetime-local" id="casZaciatku" required> </div>
                     <div class="form-group"> <label for="casSkoncenia">Dátum a čas skončenia dražby:</label> <input type="datetime-local" id="casSkoncenia" required> </div>
                     <div class="form-group form-group-full"> <label for="imageUrl">URL adresa obrázka (nepovinné):</label> <input type="url" id="imageUrl" placeholder="https://... (napr. adresa z Imgur)"> </div>
                     <div class="form-group form-group-full"> <label for="predmetDrazby">Predmet dražby (popis):</label> <textarea id="predmetDrazby" placeholder="Stručne popíšte predmet dražby..." required></textarea> </div>
                 </div>
                 <button type="submit" id="submitDrazbaButton" class="btn-primary" style="margin-top: 16px;">Vytvoriť dražbu</button>
            </form>
        </div>
    </div>

    <div id="bidderLoginModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'bidderLoginModal')"> </div>
    
    <div id="auctionDetailModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'auctionDetailModal')"> </div>
    
    <script>
        // --- JavaScript KÓD (zostáva rovnaký ako naposledy) ---
        console.log("Kontrolný bod: E-Dražba Skript začal."); 
        const API_URL = 'https://e-drazba-server.onrender.com';
        let drazbyListDiv, drazbaForm, adresaInput, okresSelect, adresaMapLink, imageUrlInput, addAuctionModal, bidderLoginModal, auctionDetailModal, bidderIdInfoDiv, currentBidderIdDisplay; 
        function openModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.classList.add('visible'); modal.classList.remove('hidden'); console.log(`Modál ${modalId} otvorený.`); } else { console.error(`Modál s ID ${modalId} nebol nájdený!`); } }
        function closeModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.classList.add('hidden'); modal.classList.remove('visible'); console.log(`Modál ${modalId} zatvorený.`); if (modalId === 'auctionDetailModal') { const contentDiv = document.getElementById('detail-content'); if (contentDiv) contentDiv.innerHTML = '<p>Načítavam detail dražby...</p>'; } } else { console.error(`Modál s ID ${modalId} nebol nájdený!`); } }
        function closeModalOnClickOutside(event, modalId) { if (event.target === document.getElementById(modalId)) { closeModal(modalId); } }
        function openAddAuctionModal() { if(drazbaForm) drazbaForm.reset(); if(adresaMapLink) adresaMapLink.style.display = 'none'; openModal('addAuctionModal'); }
        function openBidderLoginModal(auctionId) { const existingBidderId = localStorage.getItem('currentBidderId'); if (existingBidderId) { console.log(`Používateľ ${existingBidderId} už je identifikovaný, otváram rovno detail.`); openAuctionDetailModal(auctionId); return; } console.log(`Otváram login formulár pre dražbu ID: ${auctionId}`); const loginAuctionIdInput = document.getElementById('loginAuctionId'); if (loginAuctionIdInput) loginAuctionIdInput.value = auctionId; const docInput = document.getElementById('bidderIdDoc'); const mobileInput = document.getElementById('bidderMobile'); const maxBidInput = document.getElementById('bidderMaxBid'); if(docInput) docInput.value = ''; if(mobileInput) mobileInput.value = ''; if(maxBidInput) maxBidInput.value = ''; openModal('bidderLoginModal'); }
        function openAuctionDetailModal(auctionId) { console.log(`Otváram detail pre dražbu ID: ${auctionId}`); loadAuctionDetail(auctionId); openModal('auctionDetailModal'); }
        function displayBidderIdInfo() { const bidderId = localStorage.getItem('currentBidderId'); if (bidderIdInfoDiv && currentBidderIdDisplay) { if (bidderId) { const displayId = bidderId.length > 4 ? `ID: ${bidderId.substring(0, 2)}...${bidderId.substring(bidderId.length - 4)}` : bidderId; currentBidderIdDisplay.textContent = displayId; bidderIdInfoDiv.style.display = 'block'; } else { bidderIdInfoDiv.style.display = 'none'; } } }
        function clearBidderIdAndShowLogin() { if (confirm('Naozaj chcete zmeniť svoju identitu záujemcu? Budete musieť znova zadať údaje pri ďalšom vstupe do dražby.')) { localStorage.removeItem('currentBidderId'); console.log("Bidder ID vymazané z localStorage."); displayBidderIdInfo(); } }
        function updateMapLink() { if (!adresaInput || !okresSelect || !adresaMapLink) return; const address = adresaInput.value.trim(); const okres = okresSelect.value; if (address && okres) { const mapQuery = encodeURIComponent(`${address}, ${okres}`); adresaMapLink.href = `https://www.google.com/maps?q=${mapQuery}`; adresaMapLink.style.display = 'inline'; } else { adresaMapLink.style.display = 'none'; } }
        async function loadDrazby() { console.log("Načítavam dražby..."); if (!drazbyListDiv) return; drazbyListDiv.innerHTML = '<p>Načítavam zoznam dražieb...</p>'; try { const response = await fetch(`${API_URL}/api/drazby`); if (!response.ok) { let e = `Chyba servera: ${response.status}`; try { e = await response.text(); } catch(err){} throw new Error(e); } const drazby = await response.json(); drazbyListDiv.innerHTML = ''; if (!Array.isArray(drazby)) throw new Error("Zlý formát dát."); if (drazby.length === 0) { drazbyListDiv.innerHTML = '<p>Žiadne dražby.</p>'; return; } drazby.forEach((drazba, i) => { try { if (!drazba || !drazba._id) return; const item = document.createElement('div'); item.className = 'drazba-item'; const opts = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }; const start = drazba.casZaciatku ? new Date(drazba.casZaciatku).toLocaleString('sk-SK', opts) : 'N/A'; const end = drazba.casSkoncenia ? new Date(drazba.casSkoncenia).toLocaleString('sk-SK', opts) : 'N/A'; const img = drazba.imageUrl ? `<img src="${drazba.imageUrl}" alt="${drazba.predmetDrazby || ''}" class="drazba-item-image">` : '<div class="drazba-item-image" style="background-color: #eee;"></div>'; const cPrice = typeof drazba.currentPrice === 'number' ? drazba.currentPrice.toLocaleString('sk-SK') : 'N/A'; const sPrice = typeof drazba.najnizsiePodanie === 'number' ? drazba.najnizsiePodanie.toLocaleString('sk-SK') : 'N/A'; item.innerHTML = `${img}<h3>${drazba.predmetDrazby||'N/A'}</h3><p><strong>Adresa:</strong> ${drazba.adresa||'N/A'}, ${drazba.okres||'N/A'}</p><p><strong>Začiatok:</strong> ${start} | <strong>Koniec:</strong> ${end}</p><div class="price-info"><p><strong>Aktuálna cena:</strong> <span class="current-price">${cPrice} €</span></p><p><strong>Najnižšie podanie:</strong> ${sPrice} €</p></div><div class="item-footer"><button class="btn-primary" onclick="openBidderLoginModal('${drazba._id}')">Vstúpiť / Prihodiť</button><button class="btn-delete" onclick="handleDeleteAuction('${drazba._id}')">Zmazať</button></div>`; drazbyListDiv.appendChild(item); } catch (loopErr) { console.error(`Chyba pri dražbe #${i}:`, loopErr); const errItem = document.createElement('div'); errItem.className = 'drazba-item'; errItem.innerHTML = `<p style="color:red;">Chyba pri načítaní ID: ${drazba?drazba._id:'N/A'}.</p>`; drazbyListDiv.appendChild(errItem); } }); } catch (error) { console.error("Chyba v loadDrazby:", error); drazbyListDiv.innerHTML = `<p style="color: red;">Chyba: ${error.message}</p>`; } }
        async function loadAuctionDetail(auctionId) { const cDiv = document.getElementById('detail-content'); const hList = document.getElementById('bid-history-list'); const bForm = document.getElementById('bid-form'); const bInput = document.getElementById('bidAmount'); if (!cDiv || !hList || !bForm || !bInput) { closeModal('auctionDetailModal'); alert("Chyba UI detailu."); return; } cDiv.innerHTML = '<p>Načítavam...</p>'; hList.innerHTML = ''; try { const response = await fetch(`${API_URL}/api/drazby/${auctionId}`); if (!response.ok) throw new Error(`Chyba servera: ${response.statusText}`); const d = await response.json(); const opts = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }; const start = d.casZaciatku ? new Date(d.casZaciatku).toLocaleString('sk-SK', opts) : 'N/A'; const end = d.casSkoncenia ? new Date(d.casSkoncenia).toLocaleString('sk-SK', opts) : 'N/A'; let img = d.imageUrl ? `<img src="${d.imageUrl}" alt="${d.predmetDrazby}" class="detail-image">` : '<p>Obrázok N/A.</p>'; let hbDisp = 'Nikto'; if (d.highestBidder && d.highestBidder.length > 4) { hbDisp = `ID: ${d.highestBidder.substring(0, 2)}...${d.highestBidder.substring(d.highestBidder.length - 4)}`; } cDiv.innerHTML = `<div class="detail-grid"><div class="detail-image-container">${img}</div><div class="detail-info"><h2>${d.predmetDrazby||'N/A'}</h2><p><strong>Aktuálna cena:</strong> <span class="current-price">${d.currentPrice.toLocaleString('sk-SK')} €</span></p><p><strong>Najvyšší prihadzujúci:</strong> ${hbDisp}</p><hr style="border:none; border-top: 1px solid #eee; margin: 16px 0;"><p><strong>Najnižšie podanie:</strong> ${d.najnizsiePodanie.toLocaleString('sk-SK')} €</p><p><strong>Minimálne prihodenie:</strong> ${d.minimalnePrihodenie.toLocaleString('sk-SK')} €</p><p><strong>Začiatok:</strong> ${start}</p><p><strong>Koniec:</strong> ${end}</p><p><strong>Adresa:</strong> ${d.adresa||'N/A'}, ${d.okres||'N/A'}</p><p><strong>Navrhovateľ:</strong> ${d.navrhovatel||'N/A'}</p></div></div>`; bForm.dataset.auctionId = d._id; const minBid = (d.currentPrice || 0) + (d.minimalnePrihodenie || 1); bInput.min = minBid; bInput.placeholder = `Min. ${minBid.toLocaleString('sk-SK')} €`; bInput.value = minBid; if (d.bidHistory && d.bidHistory.length > 0) { d.bidHistory.reverse().forEach(b => { const li = document.createElement('li'); const time = b.timestamp ? new Date(b.timestamp).toLocaleString('sk-SK', opts) : 'N/A'; let bDisp = 'N/A'; if (b.bidderId && b.bidderId.length > 4) { bDisp = `ID: ${b.bidderId.substring(0, 2)}...${b.bidderId.substring(b.bidderId.length - 4)}`; } li.innerHTML = `<strong>${(b.amount||0).toLocaleString('sk-SK')} €</strong> (${bDisp}) - ${time}`; hList.appendChild(li); }); } else { hList.innerHTML = '<li>Žiadne prihodenia.</li>'; } } catch (e) { console.error("Chyba detailu:", e); cDiv.innerHTML = `<p style="color: red;">Chyba: ${e.message}</p>`; } }
        async function handleDrazbaSubmit(event) { event.preventDefault(); const btn = document.getElementById('submitDrazbaButton'); btn.disabled = true; btn.textContent = 'Odosielam...'; try { const data = { navrhovatel: document.getElementById('navrhovatel').value, typNehnutelnosti: document.getElementById('typNehnutelnosti').value, okres: document.getElementById('okres').value, adresa: document.getElementById('adresa').value, znalecnaCena: Number(document.getElementById('znalecnaCena').value), najnizsiePodanie: Number(document.getElementById('najnizsiePodanie').value), minimalnePrihodenie: Number(document.getElementById('minimalnePrihodenie').value), casZaciatku: document.getElementById('casZaciatku').value, casSkoncenia: document.getElementById('casSkoncenia').value, mobilNavrhovatela: document.getElementById('mobilNavrhovatela').value, predmetDrazby: document.getElementById('predmetDrazby').value, imageUrl: document.getElementById('imageUrl').value }; const response = await fetch(`${API_URL}/api/drazby`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); if (!response.ok) { const err = await response.json(); throw new Error(err.message || 'Chyba servera.'); } alert('Dražba vytvorená!'); closeModal('addAuctionModal'); loadDrazby(); } catch (e) { alert(`Chyba: ${e.message}`); } finally { btn.disabled = false; btn.textContent = 'Vytvoriť dražbu'; } }
        async function handleBidderLoginSubmit(event) { event.preventDefault(); const docIdIn = document.getElementById('bidderIdDoc'); const mobileIn = document.getElementById('bidderMobile'); const aucIdIn = document.getElementById('loginAuctionId'); const maxBidIn = document.getElementById('bidderMaxBid'); const btn = document.getElementById('bidderLoginSubmitButton'); const docId = docIdIn.value.trim().toUpperCase(); const mobile = mobileIn.value.trim(); const aucId = aucIdIn.value; const maxVal = maxBidIn.value.trim(); let maxBid = maxVal ? Number(maxVal) : null; if (!docId || !mobile || !aucId) return alert("Vyplňte doklad a mobil."); if (!/^09\d{2} \d{3} \d{3}$/.test(mobile)) return alert("Mobil v tvare 09XX XXX XXX."); if (maxBid !== null && (isNaN(maxBid) || maxBid <= 0)) return alert("Neplatný max bid."); const anonDoc = docId.length > 4 ? docId.substring(docId.length - 4) : docId; const anonMob = mobile.length > 3 ? mobile.substring(mobile.length - 3) : mobile; const bidderId = `ID-${anonDoc}${anonMob}`; btn.disabled = true; btn.textContent = 'Spracovávam...'; try { localStorage.setItem('currentBidderId', bidderId); if (maxBid !== null) { const proxyRes = await fetch(`${API_URL}/api/drazby/${aucId}/setproxy`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ bidderId: bidderId, maxBid: maxBid }) }); if (!proxyRes.ok) { const err = await proxyRes.json(); alert(`Chyba max ponuky: ${err.message}`); console.error('Chyba setproxy:', err.message); } } closeModal('bidderLoginModal'); openAuctionDetailModal(aucId); displayBidderIdInfo(); } catch (e) { alert(`Chyba: ${e.message}`); btn.disabled = false; btn.textContent = 'Vstúpiť'; } }
        async function handleBidSubmit(event) { event.preventDefault(); const form = event.target; const aucId = form.dataset.auctionId; const amountIn = document.getElementById('bidAmount'); const btn = form.querySelector('button[type="submit"]'); const amount = Number(amountIn.value); const bidderId = localStorage.getItem('currentBidderId'); if (!bidderId) { alert("Chyba ID. Skúste znova."); showZaujemcaView(); return; } btn.disabled = true; btn.textContent = 'Odosielam...'; try { const response = await fetch(`${API_URL}/api/drazby/${aucId}/bid`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ amount: amount, bidderId: bidderId }) }); if (!response.ok) { const err = await response.json(); throw new Error(err.message || 'Chyba servera.'); } alert('Prihodenie prijaté!'); loadAuctionDetail(aucId); } catch (e) { alert(`Chyba: ${e.message}`); } finally { btn.disabled = false; btn.textContent = 'Prihodiť'; } }
        async function handleDeleteAuction(auctionId) { if (!auctionId) return; if (confirm('Naozaj zmazať túto dražbu?')) { try { const response = await fetch(`${API_URL}/api/drazby/${auctionId}`, { method: 'DELETE' }); if (!response.ok) { const err = await response.json(); throw new Error(err.message || 'Chyba servera.'); } alert('Dražba zmazaná.'); loadDrazby(); } catch (e) { alert(`Chyba pri mazaní: ${e.message}`); } } }
        
        document.addEventListener('DOMContentLoaded', () => { 
             console.log("Kontrolný bod: DOM načítaný, inicializácia."); 
             try { 
                 addAuctionModal = document.getElementById('addAuctionModal'); bidderLoginModal = document.getElementById('bidderLoginModal'); auctionDetailModal = document.getElementById('auctionDetailModal'); drazbyListDiv = document.getElementById('drazby-list'); drazbaForm = document.getElementById('drazba-form'); adresaInput = document.getElementById('adresa'); okresSelect = document.getElementById('okres'); adresaMapLink = document.getElementById('adresaMapLink'); imageUrlInput = document.getElementById('imageUrl'); bidderIdInfoDiv = document.getElementById('bidder-id-info'); currentBidderIdDisplay = document.getElementById('currentBidderIdDisplay'); 
                 displayBidderIdInfo(); loadDrazby(); 
                 console.log("Kontrolný bod: Inicializácia dokončená."); 
             } catch (error) { 
                 console.error("KRITICKÁ CHYBA počas inicializácie:", error); 
                 const body = document.querySelector('body'); 
                 if(body) body.innerHTML = `<p style="color:red;">Kritická chyba: ${error.message}</p>`; 
             } 
        }); 
        
        console.log("Kontrolný bod: Skript načítaný.");
    </script>

</body>
</html>
