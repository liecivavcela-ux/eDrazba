<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Dražba (Debug ID)</title> 
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style> /* --- CSS (bez zmien) --- */ </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>E-Dražba</h1><button class="btn-primary" onclick="openAddAuctionModal()">Pridať novú dražbu</button></div>
        <div id="drazby-list"><p>Inicializujem...</p></div>
        <div id="bidder-id-info" style="display: none; text-align: right;"></div>
    </div>
    <div id="addAuctionModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'addAuctionModal')"></div>
    <div id="bidderLoginModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'bidderLoginModal')"></div>
    <div id="auctionDetailModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'auctionDetailModal')"></div>
    
    <script>
        console.log("Skript začal.");
        window.onerror = function(msg, src, line, col, err) { console.error("CHYBA JS:", msg, "@", src, `${line}:${col}`, err); document.body.innerHTML = `<p style="color:red;">CHYBA: ${msg}</p>`; return true; };
        
        const API_URL = 'https://e-drazba-server.onrender.com';
        let drazbyListDiv, drazbaForm, adresaInput, okresSelect, adresaMapLink, addAuctionModal, bidderLoginModal, auctionDetailModal, bidderIdInfoDiv, currentBidderIdDisplay; 
        
        function safeGet(id){ const el = document.getElementById(id); if(!el) { console.error(`!!! Element #${id} nenájdený !!!`); throw new Error(`Element #${id} nenájdený!`); } return el; }
        function openModal(id) { try { safeGet(id).classList.add('visible'); safeGet(id).classList.remove('hidden'); } catch(e){console.error(e);} }
        function closeModal(id) { try { const m = safeGet(id); m.classList.add('hidden'); m.classList.remove('visible'); if (id === 'auctionDetailModal') safeGet('detail-content').innerHTML = '<p>...</p>'; } catch(e){} }
        function closeModalOnClickOutside(e, id) { try { if (e.target === document.getElementById(id)) closeModal(id); } catch(e){} }
        function openAddAuctionModal() { try { safeGet('drazba-form').reset(); try{safeGet('adresaMapLink').style.display = 'none';}catch(e){} openModal('addAuctionModal'); } catch(e){console.error(e);} }
        function openBidderLoginModal(auctionId) { 
             try { 
                 const existingBidderId = localStorage.getItem('currentBidderId'); 
                 if (existingBidderId) { openAuctionDetailModal(auctionId); return; } 
                 console.log(`Login formulár pre ${auctionId}`); 
                 safeGet('loginAuctionId').value = auctionId; 
                 safeGet('bidderIdDoc').value = ''; safeGet('bidderMobile').value = ''; safeGet('bidderMaxBid').value = ''; 
                 openModal('bidderLoginModal'); 
             } catch(e){console.error(e);} 
        }
        function openAuctionDetailModal(auctionId) { try { console.log(`Otváram detail ${auctionId}`); loadAuctionDetail(auctionId); openModal('auctionDetailModal'); } catch(e){console.error(e);} }
        function displayBidderIdInfo() { /* ... bez zmien ... */ }
        function clearBidderIdAndShowLogin() { /* ... bez zmien ... */ }
        function updateMapLink() { /* ... bez zmien ... */ } 
        
        async function loadDrazby() { /* ... bez zmien ... */ } 
        
        // ===== DETAILNEJŠIE LOGOVANIE V loadAuctionDetail =====
        async function loadAuctionDetail(auctionId) { 
            console.log(`--- loadAuctionDetail START pre ID: ${auctionId} ---`);
            const cDiv=safeGet('detail-content'); const hList=safeGet('bid-history-list'); const bForm=safeGet('bid-form'); const bInput=safeGet('bidAmount'); 
            cDiv.innerHTML='<p>Načítavam...</p>'; hList.innerHTML=''; 
            // Vynulujeme staré ID pre istotu
            bForm.dataset.auctionId = ''; 
            console.log("  Form data-auction-id vynulované.");

            try { 
                console.log(`  Posielam fetch na /api/drazby/${auctionId}`);
                const r=await fetch(`${API_URL}/api/drazby/${auctionId}`); 
                console.log("  Fetch status:", r.status);
                if(!r.ok) throw new Error(`Server ${r.status}`); 
                
                console.log("  Spracovávam JSON...");
                const d=await r.json(); 
                console.log("  JSON OK, prijaté ID:", d ? d._id : 'CHYBA - žiadne dáta');

                // Kontrola, či dáta a ID existujú
                if (!d || !d._id) {
                    throw new Error("Prijaté dáta neobsahujú platné ID aukcie.");
                }
                const currentAuctionId = d._id; // Uložíme si platné ID
                console.log(`  ID aukcie potvrdené: ${currentAuctionId}`);

                const opts={dateStyle:'short',timeStyle:'short'}; 
                const start=d.casZaciatku?new Date(d.casZaciatku).toLocaleString('sk-SK',opts):'N/A'; const end=d.casSkoncenia?new Date(d.casSkoncenia).toLocaleString('sk-SK',opts):'N/A'; 
                let hb='Nikto'; if(d.highestBidder&&d.highestBidder.length>4){hb=`ID: ${d.highestBidder.substring(0,2)}...${d.highestBidder.substring(d.highestBidder.length-4)}`;} 
                
                console.log("  Renderujem HTML detailu...");
                cDiv.innerHTML=`<div class="detail-info"><h2>${d.predmetDrazby||'N/A'}</h2><p><strong>Adresa:</strong> ${d.adresa||'N/A'}, ${d.okres||'N/A'}</p><p><strong>Aktuálna cena:</strong> <span class="current-price">${(d.currentPrice||0).toLocaleString('sk-SK')} €</span></p><p><strong>Najvyšší prihadzujúci:</strong> ${hb}</p><hr><p><strong>Najnižšie podanie:</strong> ${(d.najnizsiePodanie||0).toLocaleString('sk-SK')} €</p><p><strong>Minimálne prihodenie:</strong> ${(d.minimalnePrihodenie||0).toLocaleString('sk-SK')} €</p><p><strong>Začiatok:</strong> ${start}</p><p><strong>Koniec:</strong> ${end}</p><p><strong>Navrhovateľ:</strong> ${d.navrhovatel||'N/A'}</p></div>`; 
                
                console.log(`  Nastavujem data-auction-id na formulári na: ${currentAuctionId}`);
                bForm.dataset.auctionId = currentAuctionId; // Nastavíme ID na formulár AŽ KEĎ MÁME PLATNÉ ID
                // Kontrola po nastavení
                console.log(`  Kontrola: form.dataset.auctionId je teraz: ${bForm.dataset.auctionId}`); 
                
                const minBid=(d.currentPrice||0)+(d.minimalnePrihodenie||1); bInput.min=minBid; bInput.placeholder=`Min. ${minBid.toLocaleString('sk-SK')} €`; bInput.value=minBid; 
                
                console.log("  Renderujem históriu...");
                hList.innerHTML = ''; // Vyčistíme pred pridaním
                if(d.bidHistory&&d.bidHistory.length>0){d.bidHistory.reverse().forEach(b=>{const li=document.createElement('li'); const time=b.timestamp?new Date(b.timestamp).toLocaleString('sk-SK',opts):'N/A'; let bDisp='N/A'; if(b.bidderId&&b.bidderId.length>4){bDisp=`ID: ${b.bidderId.substring(0,2)}...${b.bidderId.substring(b.bidderId.length-4)}`;} li.innerHTML=`<strong>${(b.amount||0).toLocaleString('sk-SK')} €</strong> (${bDisp}) - ${time}`; hList.appendChild(li);});} else {hList.innerHTML='<li>Žiadne prihodenia.</li>';} 
                console.log("  História OK.");
            } catch (e) { 
                console.error("KRITICKÁ CHYBA v loadAuctionDetail:", e); 
                cDiv.innerHTML=`<p style="color: red;">Chyba načítania detailu: ${e.message}</p>`; 
                // Necháme data-auction-id prázdne, ak nastala chyba
                bForm.dataset.auctionId = ''; 
                console.log("  Chyba pri načítaní, data-auction-id zostáva prázdne.");
            } finally {
                 console.log("--- loadAuctionDetail END ---");
            }
        } 
        // ====================================================

        async function handleDrazbaSubmit(event) { /* ... bez zmien ... */ }
        
        // ===== DETAILNEJŠIE LOGOVANIE V handleBidderLoginSubmit =====
        async function handleBidderLoginSubmit(event) { 
            event.preventDefault(); 
            console.log("--- handleBidderLoginSubmit START ---");
            const docIn=safeGet('bidderIdDoc'); const mobIn=safeGet('bidderMobile'); const aucIdIn=safeGet('loginAuctionId'); const maxIn=safeGet('bidderMaxBid'); const btn=safeGet('bidderLoginSubmitButton'); 
            const docId=docIn.value.trim().toUpperCase(); const mob=mobIn.value.trim(); 
            const auctionId=aucIdIn.value; // ID aukcie, pre ktorú sa prihlasujeme
            console.log(`  Login pre auctionId: ${auctionId}`);
            const maxVal=maxIn.value.trim(); let maxBid=maxVal?Number(maxVal):null; 
            if(!docId||!mob||!auctionId) return alert("Vyplňte doklad a mobil."); if(!/^09\d{2} \d{3} \d{3}$/.test(mob)) return alert("Mobil 09XX XXX XXX."); if(maxBid!==null&&(isNaN(maxBid)||maxBid<=0)) return alert("Neplatný max bid."); 
            const anonDoc=docId.length>4?docId.substring(docId.length-4):docId; const anonMob=mob.length>3?mob.substring(mob.length-3):mob; const bidderId=`ID-${anonDoc}${anonMob}`; 
            console.log(`  Vygenerované bidderId: ${bidderId}`);
            btn.disabled=true; btn.textContent='Spracovávam...'; 
            try { 
                console.log("  Ukladám bidderId do localStorage...");
                localStorage.setItem('currentBidderId', bidderId); 
                console.log("  localStorage OK.");
                if(maxBid!==null){ 
                     console.log(`  Posielam setproxy ${maxBid} pre ${auctionId}...`);
                     const proxyRes = await fetch(`${API_URL}/api/drazby/${auctionId}/setproxy`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({bidderId:bidderId, maxBid:maxBid})}); 
                     console.log("  Setproxy status:", proxyRes.status);
                     if(!proxyRes.ok){const err=await proxyRes.json(); alert(`Chyba max ponuky: ${err.message}`); console.error('Chyba setproxy:', err.message);} 
                     else { console.log("  Setproxy OK."); }
                } 
                console.log("  Zatváram login modal...");
                closeModal('bidderLoginModal'); 
                console.log("  Otváram detail modal...");
                openAuctionDetailModal(auctionId); 
                console.log("  Aktualizujem info o ID...");
                displayBidderIdInfo(); 
            } catch (e) { 
                console.error("KRITICKÁ CHYBA v handleBidderLoginSubmit:", e);
                alert(`Chyba: ${e.message}`); 
                btn.disabled=false; btn.textContent='Vstúpiť'; 
            } finally {
                 console.log("--- handleBidderLoginSubmit END ---");
            }
        } 
        // ====================================================

        // ===== DETAILNEJŠIE LOGOVANIE V handleBidSubmit =====
        async function handleBidSubmit(event) { 
            event.preventDefault(); 
            console.log("--- handleBidSubmit START ---");
            const form=event.target; 
            const auctionId = form.dataset.auctionId; // Čítame ID z formulára
            console.log(`  Čítam data-auction-id z formulára: ${auctionId}`); 
            
            // Kritická kontrola ID
            if (!auctionId) {
                console.error("  !!! CHYBA: auctionId je prázdne alebo nedefinované! Nemôžem prihodiť. !!!");
                alert("Chyba: Nepodarilo sa získať ID aukcie. Skúste znova.");
                closeModal('auctionDetailModal'); // Zatvoríme modál, lebo je neplatný
                return;
            }
            console.log(`  ID aukcie pre prihodenie: ${auctionId}`);

            const amountIn=safeGet('bidAmount'); const btn=form.querySelector('button[type="submit"]'); 
            const amount=Number(amountIn.value); 
            const bidderId = localStorage.getItem('currentBidderId'); 
            if (!bidderId) { alert("Chyba ID."); closeModal('auctionDetailModal'); return; } 
            console.log(`  Prihadzujem ako ${bidderId} sumu ${amount} na aukciu ${auctionId}`);
            btn.disabled=true; btn.textContent='Odosielam...'; 
            try { 
                console.log(`  Posielam fetch na /api/drazby/${auctionId}/bid`);
                const r=await fetch(`${API_URL}/api/drazby/${auctionId}/bid`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:amount, bidderId:bidderId})}); 
                console.log("  Fetch bid status:", r.status);
                if(!r.ok){const err=await r.json(); throw new Error(err.message||'Chyba servera.');} 
                console.log("  Prihodenie OK.");
                alert('Prihodenie OK!'); 
                console.log("  Volám loadAuctionDetail na obnovenie...");
                loadAuctionDetail(auctionId); // Obnoví detail
            } catch (e) { 
                console.error("KRITICKÁ CHYBA v handleBidSubmit:", e);
                alert(`Chyba: ${e.message}`); 
            } finally { 
                btn.disabled=false; btn.textContent='Prihodiť'; 
                console.log("--- handleBidSubmit END ---");
            } 
        } 
        // =================================================

        // Odstránená funkcia handleDeleteAuction
        
        document.addEventListener('DOMContentLoaded', () => { 
             console.log("DOM načítaný."); 
             try { 
                 console.log("Inicializujem..."); 
                 addAuctionModal = safeGet('addAuctionModal'); bidderLoginModal = safeGet('bidderLoginModal'); auctionDetailModal = safeGet('auctionDetailModal'); drazbyListDiv = safeGet('drazby-list'); drazbaForm = safeGet('drazba-form'); 
                 try { bidderIdInfoDiv = document.getElementById('bidder-id-info'); } catch(e){}
                 try { currentBidderIdDisplay = document.getElementById('currentBidderIdDisplay'); } catch(e){}
                 try { adresaInput = document.getElementById('adresa'); } catch(e){}
                 try { okresSelect = document.getElementById('okres'); } catch(e){}
                 try { adresaMapLink = document.getElementById('adresaMapLink'); } catch(e){}
                 console.log("Elementy OK.");
                 console.log("Volám displayBidderIdInfo..."); displayBidderIdInfo(); 
                 console.log("Volám loadDrazby..."); loadDrazby(); 
                 console.log("Inicializácia OK."); 
             } catch (error) { 
                 console.error("KRITICKÁ CHYBA INIT:", error); 
                 document.body.innerHTML = `<p style="color:red;">Chyba inicializácie: ${error.message}</p>`; 
             } 
        }); 
        console.log("Skript načítaný.");
    </script>

</body>
</html>
