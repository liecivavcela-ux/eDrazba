<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Dražba</title> 
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS Štýly (zostávajú rovnaké) --- */
        :root { 
            --google-blue: #1a73e8; --google-blue-hover: #1765cc; 
            --background-color: #f8f9fa; --surface-color: #ffffff; 
            --text-primary: #202124; --text-secondary: #5f6368; 
            --border-color: #dadce0; --error-color: #d93025; 
        }
        body { 
            font-family: 'Roboto', sans-serif; background-color: var(--background-color); color: var(--text-primary); 
            display: flex; justify-content: center; align-items: center; 
            padding: 24px; min-height: 100vh;
            flex-direction: column; 
        }
        #role-selection { display: flex; flex-direction: column; align-items: center; text-align: center; background-color: var(--surface-color); border-radius: 8px; padding: 40px; box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15); width: 100%; max-width: 500px; box-sizing: border-box; }
        #role-selection h1 { font-size: 28px; font-weight: 500; margin: 0 0 16px 0; }
        #role-selection p { font-size: 16px; color: var(--text-secondary); margin: 0 0 32px 0; max-width: 400px; }
        .role-buttons { display: flex; flex-direction: column; gap: 16px; width: 100%; max-width: 300px; }
        .role-buttons button { width: 100%; padding: 16px; font-size: 16px; }
        #navrhovatel-view, #zaujemca-view, #detail-view, #bidder-login-view { display: none; width: 100%; max-width: 800px; align-self: flex-start; margin-top: 0; }
        #bidder-login-view { max-width: 500px; align-self: center; margin-top: 50px; } 
        .view-header { display: flex; justify-content: flex-end; margin-bottom: 16px; width: 100%; }
        .view-header button { width: auto; }
        .panel { background-color: var(--surface-color); border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15); padding: 24px; width: 100%; box-sizing: border-box; }
        h2 { font-size: 22px; font-weight: 500; margin-top: 0; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 16px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin: 0; }
        .form-group-full { grid-column: 1 / -1; } 
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: var(--text-secondary); }
        label a.address-map-link { font-size: 12px; margin-left: 8px; float: right; } 
        input, select, textarea { width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        textarea { resize: vertical; min-height: 100px; }
        input[type="datetime-local"] { font-family: sans-serif; } 
        button { padding: 12px; font-size: 14px; font-weight: 500; border-radius: 8px; cursor: pointer; border: none; }
        button:disabled { background-color: #f1f3f4; color: #bdc1c6; cursor: not-allowed; }
        .btn-primary { background-color: var(--google-blue); color: white; width: 100%; } .btn-primary:not(:disabled):hover { background-color: var(--google-blue-hover); }
        .btn-secondary { background-color: var(--surface-color); color: var(--google-blue); border: 1px solid var(--border-color); width: auto; } .btn-secondary:not(:disabled):hover { background-color: #f8f9fa; }
        #drazby-list { display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 16px; }
        .drazba-item { background-color: #f8f9fa; border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; overflow: hidden; }
        .drazba-item h3 { margin: 0 0 12px 0; color: var(--google-blue); font-size: 18px; }
        .drazba-item-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; font-size: 14px; }
        .drazba-item-grid p { margin: 4px 0; }
        .drazba-item-grid p strong { color: var(--text-primary); }
        .drazba-item-full { grid-column: 1 / -1; }
        .drazba-item .btn-primary { width: auto; padding: 8px 16px; margin-top: 16px; }
        .drazba-item-image { width: 100%; height: 250px; object-fit: cover; border-radius: 8px; margin-bottom: 16px; }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        .detail-image { width: 100%; border-radius: 8px; object-fit: cover; }
        .detail-info h2 { border: none; padding-bottom: 8px; margin-bottom: 16px; }
        .detail-info p { font-size: 16px; margin: 8px 0; color: var(--text-secondary); }
        .detail-info p strong { color: var(--text-primary); }
        .current-price { font-size: 28px; font-weight: 500; color: var(--google-blue); display: block; margin-top: 16px; }
        .bid-form-grid { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: flex-end; }
        #bid-history-list { list-style-type: none; padding-left: 0; margin-top: 16px; max-height: 200px; overflow-y: auto; border-top: 1px solid var(--border-color); }
        #bid-history-list li { padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        #changeBidderIdButton { font-size: 12px; color: var(--text-secondary); text-decoration: underline; cursor: pointer; background: none; border: none; padding: 0; margin-top: 8px; }
         @media (max-width: 600px) { body { padding: 8px; gap: 8px;} #role-selection, #bidder-login-view { padding: 20px; margin-top: 20px; } #role-selection h1 { font-size: 24px;} .role-buttons { flex-direction: column; width: 100%;} .role-buttons button { width: 100%; } .panel { padding: 12px; } h2 { font-size: 18px; } .form-grid, .drazba-item-grid { grid-template-columns: 1fr; } .form-group-full { grid-column: 1; } .detail-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="role-selection"> </div>
    <div id="navrhovatel-view"> </div>
    <div id="zaujemca-view"> </div>
    <div id="bidder-login-view"> </div>
    <div id="detail-view"> </div>

    
    <script>
        console.log("Kontrolný bod: E-Dražba Skript začal."); 
        
        const API_URL = 'https://e-drazba-server.onrender.com';
        
        let roleSelectionDiv, navrhovatelViewDiv, zaujemcaViewDiv, detailViewDiv, bidderLoginViewDiv, 
            drazbyListDiv, drazbaForm, adresaInput, okresSelect, adresaMapLink, imageUrlInput,
            bidderIdInfoDiv, currentBidderIdDisplay; 

        // --- Prepínanie pohľadov (zostáva rovnaké) ---
        function showRoleSelection() { /* ... */ }
        function showNavrhovatelView() { /* ... */ }
        function showZaujemcaView() { /* ... */ }
        function showDetailView(auctionId) { /* ... */ }
        function showBidderLogin(auctionId) { /* ... */ }
        function displayBidderIdInfo() { /* ... */ }
        function clearBidderIdAndShowLogin() { /* ... */ }
        function updateMapLink() { /* ... */ }
        // ---------------------------------------------

        // ===== UPRAVENÁ FUNKCIA: loadDrazby s lepším logovaním a odolnosťou =====
        async function loadDrazby() {
            console.log("Načítavam dražby..."); 
            if (!drazbyListDiv) {
                console.error("Chyba: Element drazbyListDiv nebol nájdený!");
                return;
            }
            drazbyListDiv.innerHTML = '<p>Načítavam zoznam dražieb...</p>';

            try {
                // Krok 1: Fetch data
                const response = await fetch(`${API_URL}/api/drazby`);
                console.log("Odpoveď zo servera (status):", response.status); 

                if (!response.ok) {
                     // Ak server vráti chybu, skúsime prečítať text chyby
                     let errorText = `Chyba servera: ${response.status} ${response.statusText}`;
                     try {
                         errorText = await response.text(); // Prečítame telo odpovede ako text
                         console.error("Server vrátil chybovú odpoveď:", errorText);
                     } catch (e) {
                         console.error("Nepodarilo sa prečítať telo chybovej odpovede.")
                     }
                     throw new Error(errorText); // Vyhodíme chybu
                }

                // Krok 2: Parse JSON
                const drazby = await response.json();
                console.log("Dáta úspešne prijaté (JSON), počet dražieb:", drazby.length); 

                // Krok 3: Render data
                drazbyListDiv.innerHTML = ''; // Vyčistíme "Načítavam..."

                if (!Array.isArray(drazby)) {
                    console.error("Chyba: Odpoveď zo servera nie je pole (Array)!", drazby);
                    throw new Error("Prijaté dáta nemajú očakávaný formát.");
                }

                if (drazby.length === 0) {
                    drazbyListDiv.innerHTML = '<p>Momentálne nie sú k dispozícii žiadne dražby.</p>';
                    console.log("Žiadne dražby na zobrazenie.");
                    return;
                }

                // Krok 4: Loop through auctions and render each item
                drazby.forEach((drazba, index) => { 
                    // Použijeme try-catch vnútri cyklu, aby chyba jednej položky nezastavila ostatné
                    try { 
                        console.log(`Spracovávam dražbu #${index}, ID: ${drazba._id}`); 
                        
                        // Validácia základných dát (môžeme pridať viac kontrol)
                        if (!drazba || typeof drazba !== 'object' || !drazba._id) {
                            console.warn(`Položka #${index} nemá platné dáta, preskakujem.`);
                            return; // Preskočí túto iteráciu cyklu
                        }

                        const item = document.createElement('div');
                        item.className = 'drazba-item';

                        const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
                        
                        // Bezpečnejšie načítanie dátumov s kontrolou
                        const zaciatok = drazba.casZaciatku ? new Date(drazba.casZaciatku).toLocaleString('sk-SK', options) : 'Neznámy';
                        const koniec = drazba.casSkoncenia ? new Date(drazba.casSkoncenia).toLocaleString('sk-SK', options) : 'Neznámy';
                        
                        const mapQuery = encodeURIComponent(`${drazba.adresa || ''}, ${drazba.okres || ''}`);

                        let imageHtml = '';
                        if (drazba.imageUrl) {
                            imageHtml = `<img src="${drazba.imageUrl}" alt="${drazba.predmetDrazby || 'Obrázok dražby'}" class="drazba-item-image">`;
                        }

                         // Bezpečnejšie formátovanie cien s kontrolou
                         const znalecnaCenaFormatted = typeof drazba.znalecnaCena === 'number' ? drazba.znalecnaCena.toLocaleString('sk-SK') : 'N/A';
                         const najnizsiePodanieFormatted = typeof drazba.najnizsiePodanie === 'number' ? drazba.najnizsiePodanie.toLocaleString('sk-SK') : 'N/A';

                        // Zostavenie HTML pre položku
                        item.innerHTML = `
                            ${imageHtml}
                            <h3>${drazba.predmetDrazby || 'Neznámy predmet'}</h3>
                            <div class="drazba-item-grid">
                                <p><strong>Adresa:</strong> ${drazba.adresa || 'Neznáma'} <a href="https://www.google.com/maps?q=${mapQuery}" target="_blank" style="font-size: 12px;">(Mapa)</a></p>
                                <p><strong>Typ:</strong> ${drazba.typNehnutelnosti || 'Neznámy'}</p>
                                <p><strong>Znal. cena:</strong> ${znalecnaCenaFormatted} €</p>
                                <p><strong>Najnižšie podanie:</strong> ${najnizsiePodanieFormatted} €</p>
                                <p><strong>Začiatok:</strong> ${zaciatok}</p>
                                <p><strong>Koniec:</strong> ${koniec}</p>
                                <p class="drazba-item-full"><strong>Navrhovateľ:</strong> ${drazba.navrhovatel || 'Neznámy'}</p>
                            </div>
                            <button class="btn-primary" onclick="showBidderLogin('${drazba._id}')">
                                Vstúpiť do dražby
                            </button>
                        `;

                        drazbyListDiv.appendChild(item);
                        console.log(`Dražba #${index} (ID: ${drazba._id}) úspešne pridaná do zoznamu.`); 

                    } catch (loopError) {
                        // Ak nastane chyba pri spracovaní JEDNEJ položky, zalogujeme ju a pokračujeme
                        console.error(`Chyba pri spracovaní dražby #${index} (ID: ${drazba ? drazba._id : 'N/A'}):`, loopError);
                        // Môžeme sem pridať aj zobrazenie chybovej hlášky pre túto položku v UI
                         const errorItem = document.createElement('div');
                         errorItem.className = 'drazba-item';
                         errorItem.innerHTML = `<p style="color:red;">Chyba pri načítaní detailov tejto dražby (ID: ${drazba ? drazba._id : 'N/A'}).</p>`;
                         drazbyListDiv.appendChild(errorItem);
                    }
                }); // Koniec forEach

            } catch (error) { // Chyba pri fetch, json parse alebo ak response nie je pole
                console.error("Celková chyba v loadDrazby:", error);
                console.error("Stack trace:", error.stack); // Vypíšeme aj stack trace pre lepšie ladenie
                drazbyListDiv.innerHTML = `<p style="color: red;">Nastala chyba pri načítaní zoznamu dražieb. Skúste obnoviť stránku. Detail chyby: ${error.message}</p>`;
            }
        }
        // =================================================================


        async function loadAuctionDetail(auctionId) { /* ... zostáva rovnaké s opravou pre substring ... */ }
        async function handleDrazbaSubmit(event) { /* ... zostáva rovnaké ... */ }
        async function handleBidderLoginSubmit(event) { /* ... zostáva rovnaké ... */ }
        async function handleBidSubmit(event) { /* ... zostáva rovnaké ... */ }

        // --- INICIALIZÁCIA APLIKÁCIE (zostáva rovnaká) ---
        document.addEventListener('DOMContentLoaded', () => { 
             console.log("Kontrolný bod: DOM načítaný, inicializácia.");
             try {
                 roleSelectionDiv = document.getElementById('role-selection'); 
                 navrhovatelViewDiv = document.getElementById('navrhovatel-view'); 
                 zaujemcaViewDiv = document.getElementById('zaujemca-view'); 
                 detailViewDiv = document.getElementById('detail-view'); 
                 bidderLoginViewDiv = document.getElementById('bidder-login-view'); 
                 drazbyListDiv = document.getElementById('drazby-list'); 
                 drazbaForm = document.getElementById('drazba-form'); 
                 adresaInput = document.getElementById('adresa'); 
                 okresSelect = document.getElementById('okres'); 
                 adresaMapLink = document.getElementById('adresaMapLink'); 
                 imageUrlInput = document.getElementById('imageUrl');
                 bidderIdInfoDiv = document.getElementById('bidder-id-info');
                 currentBidderIdDisplay = document.getElementById('currentBidderIdDisplay');
                 
                 showRoleSelection(); 
                 
                 console.log("Kontrolný bod: Inicializácia dokončená.");
             } catch (error) { 
                 console.error("KRITICKÁ CHYBA počas inicializácie:", error); 
                 const body = document.querySelector('body'); 
                 if(body) body.innerHTML = `<p style="color:red;">Kritická chyba: ${error.message}</p>`; 
             }
        });
        
        console.log("Kontrolný bod: Skript načítaný.");
    </script>

</body>
</html>
