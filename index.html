<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Dražba (Jedna Stránka)</title> 
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --google-blue: #1a73e8; --google-blue-hover: #1765cc; 
            --background-color: #f8f9fa; --surface-color: #ffffff; 
            --text-primary: #202124; --text-secondary: #5f6368; 
            --border-color: #dadce0; --error-color: #d93025; 
        }
        body { 
            font-family: 'Roboto', sans-serif; background-color: var(--background-color); color: var(--text-primary); 
            margin: 0; padding: 24px; box-sizing: border-box;
        }
        .container {
            width: 100%; max-width: 900px; /* Širší kontajner pre zoznam */
            margin: 20px auto; 
        }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px; padding-bottom: 16px; 
            border-bottom: 1px solid var(--border-color);
        }
        .header h1 { font-size: 28px; font-weight: 500; margin: 0; }

        /* --- Štýly pre zoznam dražieb (podobné ako predtým) --- */
        #drazby-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; } /* Mriežka kariet */
        .drazba-item { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; overflow: hidden; box-shadow: 0 1px 2px rgba(60,64,67,0.3); display: flex; flex-direction: column; }
        .drazba-item img.drazba-item-image { width: 100%; height: 180px; object-fit: cover; border-radius: 4px; margin-bottom: 12px; background-color: #eee; } /* Menší obrázok */
        .drazba-item h3 { margin: 0 0 8px 0; color: var(--google-blue); font-size: 18px; font-weight: 500; }
        .drazba-item p { font-size: 14px; color: var(--text-secondary); margin: 4px 0; }
        .drazba-item p strong { color: var(--text-primary); }
        .drazba-item .price-info { margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); }
        .drazba-item .current-price { font-weight: 500; color: var(--google-blue); font-size: 16px; }
        .drazba-item .item-footer { margin-top: auto; /* Tlačitlá na spodku karty */ display: flex; gap: 8px; padding-top: 16px; }
        .drazba-item .btn-primary { width: 100%; } /* Hlavné tlačidlo na celú šírku */
        .btn-delete { background-color: var(--error-color); color: white; font-size: 12px; padding: 6px 10px; width: auto; } .btn-delete:hover { background-color: #c5221f; }
        
        /* --- Štýly pre Modálne Okná --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Polopriehľadné pozadie */
            display: none; /* Štandardne skryté */
            justify-content: center; align-items: center; 
            z-index: 1000; /* Nad ostatným obsahom */
            padding: 20px; box-sizing: border-box;
            overflow-y: auto; /* Pre prípad dlhého obsahu */
        }
        .modal-content {
            background-color: var(--surface-color); border-radius: 8px;
            padding: 32px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 100%; max-width: 700px; /* Max šírka pre formuláre a detail */
            position: relative;
        }
        .modal-close-btn {
            position: absolute; top: 10px; right: 10px;
            background: none; border: none; font-size: 24px; 
            color: var(--text-secondary); cursor: pointer; line-height: 1;
        }
        .modal-content h2 { margin-top: 0; font-size: 24px; }
        /* Prispôsobenie formulára v modálnom okne */
        .modal-content .form-grid { grid-template-columns: 1fr 1fr; }
        .modal-content .form-group { margin-bottom: 16px; }

        /* Špecifické štýly pre Login Modal */
        #bidder-login-modal .modal-content { max-width: 500px; } 

        /* Štýly pre Detail/Prihodenie Modal (podobné ako predtým) */
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        .detail-image { width: 100%; border-radius: 8px; object-fit: cover; max-height: 400px; }
        .detail-info h2 { border: none; padding-bottom: 8px; margin-bottom: 16px; font-size: 22px; }
        .detail-info p { font-size: 16px; margin: 8px 0; color: var(--text-secondary); }
        .detail-info p strong { color: var(--text-primary); }
        .detail-info .current-price { font-size: 28px; font-weight: 500; color: var(--google-blue); display: block; margin-top: 16px; }
        .bid-form-grid { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: flex-end; }
        #bid-history-list { list-style-type: none; padding-left: 0; margin-top: 16px; max-height: 200px; overflow-y: auto; border-top: 1px solid var(--border-color); }
        #bid-history-list li { padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        
        /* Responzivita */
         @media (max-width: 768px) { 
             .header { flex-direction: column; align-items: flex-start; gap: 10px;}
             #drazby-list { grid-template-columns: 1fr; } /* Jeden stĺpec na mobile */
             .modal-content { padding: 24px; }
             .modal-content .form-grid { grid-template-columns: 1fr; }
             .detail-grid { grid-template-columns: 1fr; } 
         }
         
        /* Pomocná trieda na skrytie/zobrazenie */
        .hidden { display: none !important; } 
        .visible { display: flex !important; } /* Pre modal overlay */
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>E-Dražba</h1>
            <button class="btn-primary" onclick="openAddAuctionModal()">Pridať novú dražbu</button>
        </div>

        <div id="drazby-list">
            <p>Načítavam zoznam dražieb...</p>
        </div>
        
         <div id="bidder-id-info" style="margin-top: 20px; font-size: 14px; color: var(--text-secondary); display: none; text-align: right;">
             Prihadzujete ako: <strong id="currentBidderIdDisplay"></strong> 
             <button id="changeBidderIdButton" onclick="clearBidderIdAndShowLogin()">Zmeniť</button>
         </div>
    </div>


    <div id="addAuctionModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'addAuctionModal')">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('addAuctionModal')">&times;</button>
            <h2>Navrhnúť novú dražbu</h2>
            <form id="drazba-form" onsubmit="handleDrazbaSubmit(event)">
                 <div class="form-grid">
                     <div class="form-group"> <label for="navrhovatel">Navrhovateľ:</label> <select id="navrhovatel" required> <option value="">-- Vyberte rolu --</option> <option value="Vlastník">Vlastník</option> <option value="Dražobník">Dražobník</option> <option value="Exekútor">Exekútor</option> <option value="Správca">Správca</option> </select> </div>
                     <div class="form-group"> <label for="typNehnutelnosti">Typ nehnuteľnosti:</label> <select id="typNehnutelnosti" required> <option value="">-- Vyberte typ --</option> <option value="Garzónka">Garzónka</option> <option value="1-izbový byt">1-izbový byt</option> <option value="2-izbový byt">2-izbový byt</option> <option value="3-izbový byt">3-izbový byt</option> <option value="4-izbový byt">4-izbový byt</option> <option value="Rodinný dom">Rodinný dom</option> <option value="Garáž">Garáž</option> <option value="Záhrada">Záhrada</option> <option value="Stavebný pozemok">Stavebný pozemok</option> <option value="Komerčný objekt">Komerčný objekt</option> <option value="Iné">Iné</option> </select> </div>
                     <div class="form-group"> <label for="okres">Okres:</label> <select id="okres" required onchange="updateMapLink()"> <option value="">-- Vyberte okres --</option> </select> </div>
                     <div class="form-group"> <label for="adresa">Adresa nehnuteľnosti: <a href="#" id="adresaMapLink" target="_blank" class="address-map-link" style="display: none;">(Zobrať na mape)</a> </label> <input type="text" id="adresa" placeholder="Napr. Hlavná 1, 91701 Trnava" required oninput="updateMapLink()"> </div>
                     <div class="form-group"> <label for="znalecnaCena">Znalcom určená cena (€):</label> <input type="number" id="znalecnaCena" placeholder="Napr. 150000" min="0" required> </div>
                     <div class="form-group"> <label for="najnizsiePodanie">Najnižšie podanie (€):</label> <input type="number" id="najnizsiePodanie" placeholder="Napr. 100000" min="0" required> </div>
                     <div class="form-group"> <label for="minimalnePrihodenie">Minimálne prihodenie (€):</label> <input type="number" id="minimalnePrihodenie" placeholder="Napr. 1000" min="1" required> </div>
                     <div class="form-group"> <label for="mobilNavrhovatela">Kontaktný mobil (10 číslic):</label> <input type="tel" id="mobilNavrhovatela" placeholder="09XX XXX XXX" required> </div>
                     <div class="form-group"> <label for="casZaciatku">Dátum a čas začatia dražby:</label> <input type="datetime-local" id="casZaciatku" required> </div>
                     <div class="form-group"> <label for="casSkoncenia">Dátum a čas skončenia dražby:</label> <input type="datetime-local" id="casSkoncenia" required> </div>
                     <div class="form-group form-group-full"> <label for="imageUrl">URL adresa obrázka (nepovinné):</label> <input type="url" id="imageUrl" placeholder="https://... (napr. adresa z Imgur)"> </div>
                     <div class="form-group form-group-full"> <label for="predmetDrazby">Predmet dražby (popis):</label> <textarea id="predmetDrazby" placeholder="Stručne popíšte predmet dražby..." required></textarea> </div>
                 </div>
                 <button type="submit" id="submitDrazbaButton" class="btn-primary" style="margin-top: 16px;">Vytvoriť dražbu</button>
            </form>
        </div>
    </div>

    <div id="bidderLoginModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'bidderLoginModal')">
         <div class="modal-content">
             <button class="modal-close-btn" onclick="closeModal('bidderLoginModal')">&times;</button>
             <h2>Identifikácia záujemcu</h2>
             <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 24px;"> Pre vstup do dražby zadajte prosím Vaše číslo dokladu totožnosti a mobilné číslo. Vaša identita zostane ostatným účastníkom skrytá. </p>
             <form id="bidder-login-form" onsubmit="handleBidderLoginSubmit(event)">
                 <input type="hidden" id="loginAuctionId" value=""> 
                 <div class="form-group" style="margin-bottom: 16px;"> <label for="bidderIdDoc">Číslo dokladu totožnosti (napr. OP):</label> <input type="text" id="bidderIdDoc" placeholder="Napr. EB123456" required> </div>
                 <div class="form-group" style="margin-bottom: 16px;"> <label for="bidderMobile">Mobilné číslo (formát 09XX XXX XXX):</label> <input type="tel" id="bidderMobile" placeholder="09XX XXX XXX" pattern="09\d{2} \d{3} \d{3}" required title="Zadajte číslo v tvare 09XX XXX XXX"> </div>
                 <div class="form-group" style="margin-bottom: 24px;"> <label for="bidderMaxBid">Moja maximálna ponuka (€) (nepovinné):</label> <input type="number" id="bidderMaxBid" placeholder="Zadajte Váš limit" min="0"> <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 4px;">Ak zadáte, systém bude automaticky prihadzovať za Vás až do tejto sumy.</small> </div>
                 <button type="submit" id="bidderLoginSubmitButton" class="btn-primary">Vstúpiť do dražby</button> 
             </form>
         </div>
    </div>
    
    <div id="auctionDetailModal" class="modal-overlay" onclick="closeModalOnClickOutside(event, 'auctionDetailModal')">
         <div class="modal-content">
             <button class="modal-close-btn" onclick="closeModal('auctionDetailModal')">&times;</button>
             <div id="detail-content"> <p>Načítavam detail dražby...</p> </div>
             <h2 style="margin-top: 24px;">Prihadzovanie</h2>
             <form id="bid-form" onsubmit="handleBidSubmit(event)" data-auction-id="">
                 <div class="bid-form-grid">
                     <div class="form-group"> <label for="bidAmount">Vaša ponuka (€):</label> <input type="number" id="bidAmount" placeholder="Zadajte sumu" min="0" required> </div>
                     <button type="submit" class="btn-primary" style="width: auto;">Prihodiť</button>
                 </div>
             </form>
             <h2 style="margin-top: 24px;">História prihodení</h2>
             <ul id="bid-history-list"> <li>Zatiaľ žiadne prihodenia.</li> </ul>
         </div>
    </div>
    
    <script>
        console.log("Kontrolný bod: E-Dražba Skript začal."); 
        
        const API_URL = 'https://e-drazba-server.onrender.com';
        
        // --- Globálne premenné ---
        let drazbyListDiv, drazbaForm, adresaInput, okresSelect, adresaMapLink, imageUrlInput,
            addAuctionModal, bidderLoginModal, auctionDetailModal, // Modálne okná
            bidderIdInfoDiv, currentBidderIdDisplay; // Info o Bidder ID

        // --- Funkcie na ovládanie Modálnych Okien ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('visible'); // Použijeme .visible triedu
                modal.classList.remove('hidden');
                console.log(`Modál ${modalId} otvorený.`);
            } else { console.error(`Modál s ID ${modalId} nebol nájdený!`); }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                 modal.classList.add('hidden'); 
                 modal.classList.remove('visible');
                 console.log(`Modál ${modalId} zatvorený.`);
                 // Vyčistíme obsah detailu po zatvorení
                 if (modalId === 'auctionDetailModal') {
                     const contentDiv = document.getElementById('detail-content');
                     if (contentDiv) contentDiv.innerHTML = '<p>Načítavam detail dražby...</p>'; 
                 }
            } else { console.error(`Modál s ID ${modalId} nebol nájdený!`); }
        }
        
        // Zatvorenie kliknutím mimo obsahu modálu
        function closeModalOnClickOutside(event, modalId) {
             if (event.target === document.getElementById(modalId)) {
                 closeModal(modalId);
             }
         }

        // --- Funkcie Špecifické pre Modály ---
        function openAddAuctionModal() {
             // Vyčistíme formulár pred otvorením
             if(drazbaForm) drazbaForm.reset(); 
             if(adresaMapLink) adresaMapLink.style.display = 'none'; 
             openModal('addAuctionModal');
         }
         
        function openBidderLoginModal(auctionId) {
             const existingBidderId = localStorage.getItem('currentBidderId');
             if (existingBidderId) {
                 console.log(`Používateľ ${existingBidderId} už je identifikovaný, otváram rovno detail.`);
                 openAuctionDetailModal(auctionId); // Ak už máme ID, ideme rovno na detail
                 return; 
             }
             
             console.log(`Otváram login formulár pre dražbu ID: ${auctionId}`);
             const loginAuctionIdInput = document.getElementById('loginAuctionId');
             if (loginAuctionIdInput) loginAuctionIdInput.value = auctionId;
             
             // Vyčistíme formulár
             const docInput = document.getElementById('bidderIdDoc');
             const mobileInput = document.getElementById('bidderMobile');
             const maxBidInput = document.getElementById('bidderMaxBid');
             if(docInput) docInput.value = '';
             if(mobileInput) mobileInput.value = '';
             if(maxBidInput) maxBidInput.value = '';
             
             openModal('bidderLoginModal');
         }

        function openAuctionDetailModal(auctionId) {
             console.log(`Otváram detail pre dražbu ID: ${auctionId}`);
             loadAuctionDetail(auctionId); // Načítame dáta
             openModal('auctionDetailModal'); // A zobrazíme modál
         }
         
        // --- Zobrazenie/Skrytie Info o Bidder ID ---
        function displayBidderIdInfo() {
            const bidderId = localStorage.getItem('currentBidderId');
            if (bidderIdInfoDiv && currentBidderIdDisplay) {
                if (bidderId) {
                    const displayId = bidderId.length > 4 ? `ID: ${bidderId.substring(0, 2)}...${bidderId.substring(bidderId.length - 4)}` : bidderId;
                    currentBidderIdDisplay.textContent = displayId;
                    bidderIdInfoDiv.style.display = 'block'; 
                } else {
                    bidderIdInfoDiv.style.display = 'none'; 
                }
            }
        }
        
        // --- Vymazanie Bidder ID ---
        function clearBidderIdAndShowLogin() {
            if (confirm('Naozaj chcete zmeniť svoju identitu záujemcu? Budete musieť znova zadať údaje pri ďalšom vstupe do dražby.')) {
                localStorage.removeItem('currentBidderId');
                console.log("Bidder ID vymazané z localStorage.");
                displayBidderIdInfo(); // Aktualizujeme zobrazenie (skryje sa)
            }
        }
        // ====================================================================

        
        function updateMapLink() { /* ... zostáva rovnaké ... */ } 
        
        // ===== UPRAVENÁ FUNKCIA: loadDrazby =====
        // Teraz renderuje karty a pridáva tlačidlá na mazanie a vstup
        async function loadDrazby() {
            console.log("Načítavam dražby..."); 
            if (!drazbyListDiv) { console.error("Chyba: Element drazbyListDiv nebol nájdený!"); return; }
            drazbyListDiv.innerHTML = '<p>Načítavam zoznam dražieb...</p>';

            try {
                const response = await fetch(`${API_URL}/api/drazby`);
                if (!response.ok) { let errorText = `Chyba servera: ${response.status}`; try { errorText = await response.text(); } catch(e){} throw new Error(errorText); }
                const drazby = await response.json();
                console.log("Dáta úspešne prijaté, počet dražieb:", drazby.length); 
                drazbyListDiv.innerHTML = ''; 
                if (!Array.isArray(drazby)) { throw new Error("Prijaté dáta nemajú očakávaný formát."); }
                if (drazby.length === 0) { drazbyListDiv.innerHTML = '<p>Momentálne nie sú k dispozícii žiadne dražby.</p>'; return; }

                drazby.forEach((drazba, index) => { 
                    try { 
                        if (!drazba || !drazba._id) { console.warn(`Položka #${index} nemá platné dáta.`); return; }
                        const item = document.createElement('div'); item.className = 'drazba-item';
                        const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
                        const zaciatok = drazba.casZaciatku ? new Date(drazba.casZaciatku).toLocaleString('sk-SK', options) : 'N/A';
                        const koniec = drazba.casSkoncenia ? new Date(drazba.casSkoncenia).toLocaleString('sk-SK', options) : 'N/A';
                        let imageHtml = drazba.imageUrl ? `<img src="${drazba.imageUrl}" alt="${drazba.predmetDrazby || ''}" class="drazba-item-image">` : '<div class="drazba-item-image" style="background-color: #eee;"></div>'; // Placeholder, ak nie je obrázok
                        const currentPriceFormatted = typeof drazba.currentPrice === 'number' ? drazba.currentPrice.toLocaleString('sk-SK') : 'N/A';
                        const najnizsiePodanieFormatted = typeof drazba.najnizsiePodanie === 'number' ? drazba.najnizsiePodanie.toLocaleString('sk-SK') : 'N/A';

                        item.innerHTML = `
                            ${imageHtml}
                            <h3>${drazba.predmetDrazby || 'Neznámy predmet'}</h3>
                            <p><strong>Adresa:</strong> ${drazba.adresa || 'N/A'}, ${drazba.okres || 'N/A'}</p>
                            <p><strong>Začiatok:</strong> ${zaciatok} | <strong>Koniec:</strong> ${koniec}</p>
                            <div class="price-info">
                                <p><strong>Aktuálna cena:</strong> <span class="current-price">${currentPriceFormatted} €</span></p>
                                <p><strong>Najnižšie podanie:</strong> ${najnizsiePodanieFormatted} €</p>
                            </div>
                            <div class="item-footer">
                                <button class="btn-primary" onclick="openBidderLoginModal('${drazba._id}')">
                                    Vstúpiť / Prihodiť
                                </button>
                                <button class="btn-delete" onclick="handleDeleteAuction('${drazba._id}')">
                                    Zmazať
                                </button>
                            </div>
                        `;
                        drazbyListDiv.appendChild(item);
                    } catch (loopError) {
                        console.error(`Chyba pri spracovaní dražby #${index} (ID: ${drazba ? drazba._id : 'N/A'}):`, loopError);
                        const errorItem = document.createElement('div'); errorItem.className = 'drazba-item';
                        errorItem.innerHTML = `<p style="color:red;">Chyba pri načítaní detailov tejto dražby (ID: ${drazba ? drazba._id : 'N/A'}).</p>`;
                        drazbyListDiv.appendChild(errorItem);
                    }
                }); 
            } catch (error) { 
                console.error("Celková chyba v loadDrazby:", error); 
                drazbyListDiv.innerHTML = `<p style="color: red;">Nastala chyba pri načítaní zoznamu dražieb. Detail: ${error.message}</p>`;
            }
        }
        // =================================================================

        // ===== UPRAVENÁ FUNKCIA: loadAuctionDetail =====
        // Teraz renderuje obsah do modálneho okna
        async function loadAuctionDetail(auctionId) {
            const contentDiv = document.getElementById('detail-content');
            const historyList = document.getElementById('bid-history-list');
            const bidForm = document.getElementById('bid-form');
            const bidAmountInput = document.getElementById('bidAmount');

            if (!contentDiv || !historyList || !bidForm || !bidAmountInput) {
                 console.error("Chyba: Chýbajú elementy v detaile modálu!");
                 // Zatvoríme modál, ak chýbajú kľúčové časti
                 closeModal('auctionDetailModal'); 
                 alert("Chyba pri zobrazovaní detailu.");
                 return;
            }

            contentDiv.innerHTML = '<p>Načítavam detail dražby...</p>'; 
            historyList.innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/api/drazby/${auctionId}`); 
                if (!response.ok) throw new Error(`Chyba servera: ${response.statusText}`); 
                const drazba = await response.json(); 
                const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }; 
                const zaciatok = drazba.casZaciatku ? new Date(drazba.casZaciatku).toLocaleString('sk-SK', options) : 'N/A'; 
                const koniec = drazba.casSkoncenia ? new Date(drazba.casSkoncenia).toLocaleString('sk-SK', options) : 'N/A'; 
                let imageHtml = drazba.imageUrl ? `<img src="${drazba.imageUrl}" alt="${drazba.predmetDrazby}" class="detail-image">` : '<p>Obrázok nebol poskytnutý.</p>'; 
                let highestBidderDisplay = 'Nikto'; if (drazba.highestBidder && drazba.highestBidder.length > 4) { highestBidderDisplay = `ID: ${drazba.highestBidder.substring(0, 2)}...${drazba.highestBidder.substring(drazba.highestBidder.length - 4)}`; } 
                
                contentDiv.innerHTML = ` 
                    <div class="detail-grid"> 
                        <div class="detail-image-container"> ${imageHtml} </div> 
                        <div class="detail-info"> 
                            <h2>${drazba.predmetDrazby || 'N/A'}</h2> 
                            <p><strong>Aktuálna cena:</strong> <span class="current-price">${drazba.currentPrice.toLocaleString('sk-SK')} €</span></p> 
                            <p><strong>Najvyšší prihadzujúci:</strong> ${highestBidderDisplay}</p> 
                            <hr style="border:none; border-top: 1px solid #eee; margin: 16px 0;"> 
                            <p><strong>Najnižšie podanie:</strong> ${drazba.najnizsiePodanie.toLocaleString('sk-SK')} €</p> 
                            <p><strong>Minimálne prihodenie:</strong> ${drazba.minimalnePrihodenie.toLocaleString('sk-SK')} €</p> 
                            <p><strong>Začiatok:</strong> ${zaciatok}</p> 
                            <p><strong>Koniec:</strong> ${koniec}</p> 
                            <p><strong>Adresa:</strong> ${drazba.adresa || 'N/A'}, ${drazba.okres || 'N/A'}</p> 
                            <p><strong>Navrhovateľ:</strong> ${drazba.navrhovatel || 'N/A'}</p> 
                        </div> 
                    </div> 
                `; 
                bidForm.dataset.auctionId = drazba._id; 
                const minBid = (drazba.currentPrice || 0) + (drazba.minimalnePrihodenie || 1); // Bezpečnejší výpočet
                bidAmountInput.min = minBid; 
                bidAmountInput.placeholder = `Min. ${minBid.toLocaleString('sk-SK')} €`; 
                bidAmountInput.value = minBid; 
                
                if (drazba.bidHistory && drazba.bidHistory.length > 0) { 
                    drazba.bidHistory.reverse().forEach(bid => { 
                        const li = document.createElement('li'); 
                        const bidTime = bid.timestamp ? new Date(bid.timestamp).toLocaleString('sk-SK', options) : 'N/A'; 
                        let bidderDisplay = 'Neznámy'; if (bid.bidderId && bid.bidderId.length > 4) { bidderDisplay = `ID: ${bid.bidderId.substring(0, 2)}...${bid.bidderId.substring(bid.bidderId.length - 4)}`; } 
                        li.innerHTML = `<strong>${(bid.amount || 0).toLocaleString('sk-SK')} €</strong> (${bidderDisplay}) - ${bidTime}`; 
                        historyList.appendChild(li); 
                    }); 
                } else { historyList.innerHTML = '<li>Zatiaľ žiadne prihodenia.</li>'; } 
            } catch (error) { 
                console.error("Chyba pri načítaní detailu dražby:", error); 
                contentDiv.innerHTML = `<p style="color: red;">Chyba pri načítaní detailu: ${error.message}</p>`; 
            } 
        }
        // =================================================================

        // ===== UPRAVENÁ FUNKCIA: handleDrazbaSubmit =====
        // Po úspechu zatvorí modál a obnoví zoznam
        async function handleDrazbaSubmit(event) { 
            event.preventDefault(); console.log("Formulár pridania sa odosiela..."); 
            const submitButton = document.getElementById('submitDrazbaButton'); 
            submitButton.disabled = true; submitButton.textContent = 'Odosielam...'; 
            try { 
                const data = { /* ... zber dát z formulára ... */ };
                const response = await fetch(`${API_URL}/api/drazby`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); 
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || 'Server vrátil chybu.'); } 
                alert('Dražba bola úspešne vytvorená!'); 
                closeModal('addAuctionModal'); // Zatvoríme modál
                loadDrazby(); // Obnovíme zoznam na hlavnej stránke
            } catch (error) { 
                console.error("Chyba pri odosielaní formulára:", error); 
                alert(`Nastala chyba pri vytváraní dražby: ${error.message}`); 
            } finally { 
                submitButton.disabled = false; submitButton.textContent = 'Vytvoriť dražbu'; 
            } 
        }
        // =================================================================

        // ===== UPRAVENÁ FUNKCIA: handleBidderLoginSubmit =====
        // Po úspechu zatvorí login modál a otvorí detail modál
        async function handleBidderLoginSubmit(event) { 
            event.preventDefault(); console.log("Spracovávam bidder login...");
            const docIdInput = document.getElementById('bidderIdDoc'); const mobileInput = document.getElementById('bidderMobile'); const auctionIdInput = document.getElementById('loginAuctionId'); const maxBidInput = document.getElementById('bidderMaxBid'); const submitButton = document.getElementById('bidderLoginSubmitButton'); 
            const docId = docIdInput.value.trim().toUpperCase(); const mobile = mobileInput.value.trim(); const auctionId = auctionIdInput.value; const maxBidValue = maxBidInput.value.trim(); let maxBid = maxBidValue ? Number(maxBidValue) : null; 
            if (!docId || !mobile || !auctionId) { /* ... validácia ... */ return; } 
            if (!/^09\d{2} \d{3} \d{3}$/.test(mobile)) { /* ... validácia ... */ return; } 
            if (maxBid !== null && (isNaN(maxBid) || maxBid <= 0)) { /* ... validácia ... */ return; } 
            const anonymizedDocId = docId.length > 4 ? docId.substring(docId.length - 4) : docId; const anonymizedMobile = mobile.length > 3 ? mobile.substring(mobile.length - 3) : mobile; const bidderIdentifier = `ID-${anonymizedDocId}${anonymizedMobile}`; 
            submitButton.disabled = true; submitButton.textContent = 'Spracovávam...'; 
            try { 
                localStorage.setItem('currentBidderId', bidderIdentifier); 
                if (maxBid !== null) { 
                    const proxyResponse = await fetch(`${API_URL}/api/drazby/${auctionId}/setproxy`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ bidderId: bidderIdentifier, maxBid: maxBid }) }); 
                    if (!proxyResponse.ok) { const errorData = await proxyResponse.json(); alert(`Chyba pri nastavovaní maximálnej ponuky: ${errorData.message}`); console.error('Chyba pri setproxy:', errorData.message); } 
                } 
                closeModal('bidderLoginModal'); // Zatvoríme login modál
                openAuctionDetailModal(auctionId); // Otvoríme detail modál
                displayBidderIdInfo(); // Aktualizujeme info na hlavnej stránke
            } catch (error) { 
                console.error("Chyba pri bidder login alebo setproxy:", error); 
                alert(`Nastala chyba: ${error.message}`); 
                submitButton.disabled = false; submitButton.textContent = 'Vstúpiť do dražby'; 
            } 
        }
        // ==================================================================

        // ===== UPRAVENÁ FUNKCIA: handleBidSubmit =====
        // Zostáva rovnaká, lebo loadAuctionDetail sa volá a prekreslí obsah modálu
        async function handleBidSubmit(event) { /* ... zostáva rovnaká ... */ } 
        // ==================================================================

        // ===== NOVÁ FUNKCIA: Mazanie Aukcie =====
        async function handleDeleteAuction(auctionId) {
             if (!auctionId) return;
             
             // Dáme používateľovi potvrdenie
             if (confirm('Naozaj chcete natrvalo zmazať túto dražbu?')) {
                 console.log(`Pokus o zmazanie aukcie ID: ${auctionId}`);
                 try {
                     const response = await fetch(`${API_URL}/api/drazby/${auctionId}`, {
                         method: 'DELETE' 
                     });

                     if (!response.ok) {
                         const errorData = await response.json();
                         throw new Error(errorData.message || 'Server vrátil chybu pri mazaní.');
                     }

                     const result = await response.json();
                     console.log('Odpoveď zo servera (mazanie):', result.message);
                     alert('Dražba bola úspešne zmazaná.');
                     
                     loadDrazby(); // Obnovíme zoznam na hlavnej stránke

                 } catch (error) {
                     console.error('Chyba pri mazaní aukcie:', error);
                     alert(`Nastala chyba pri mazaní dražby: ${error.message}`);
                 }
             }
         }
        // =========================================

        // --- INICIALIZÁCIA APLIKÁCIE ---
        document.addEventListener('DOMContentLoaded', () => { 
             console.log("Kontrolný bod: DOM načítaný, inicializácia."); 
             try { 
                 // Inicializujeme elementy pre modály
                 addAuctionModal = document.getElementById('addAuctionModal');
                 bidderLoginModal = document.getElementById('bidderLoginModal');
                 auctionDetailModal = document.getElementById('auctionDetailModal');
                 
                 // Ostatné elementy
                 drazbyListDiv = document.getElementById('drazby-list'); 
                 drazbaForm = document.getElementById('drazba-form'); 
                 adresaInput = document.getElementById('adresa'); 
                 okresSelect = document.getElementById('okres'); 
                 adresaMapLink = document.getElementById('adresaMapLink'); 
                 imageUrlInput = document.getElementById('imageUrl');
                 bidderIdInfoDiv = document.getElementById('bidder-id-info');
                 currentBidderIdDisplay = document.getElementById('currentBidderIdDisplay');
                 
                 // Na začiatku načítame zoznam dražieb a zobrazíme info o ID (ak je)
                 displayBidderIdInfo(); 
                 loadDrazby(); 
                 
                 console.log("Kontrolný bod: Inicializácia dokončená."); 
             } catch (error) { 
                 console.error("KRITICKÁ CHYBA počas inicializácie:", error); 
                 const body = document.querySelector('body'); 
                 if(body) body.innerHTML = `<p style="color:red;">Kritická chyba počas inicializácie: ${error.message}</p>`; 
             } 
        }); 
        
        console.log("Kontrolný bod: Skript načítaný.");
    </script>

</body>
</html>
