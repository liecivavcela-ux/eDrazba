<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Dražba (Profi Verzia v3)</title> 
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS (bez zmien) --- */
        :root { --google-blue: #1a73e8; --google-blue-hover: #1765cc; --background-color: #f8f9fa; --surface-color: #ffffff; --text-primary: #202124; --text-secondary: #5f6368; --border-color: #dadce0; --error-color: #d93025; --success-color: #1e8e3e; --warning-color: #f9ab00; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--background-color); color: var(--text-primary); display: flex; justify-content: center; align-items: center; padding: 24px; min-height: 100vh; flex-direction: column; }
        #role-selection { display: flex; flex-direction: column; align-items: center; text-align: center; background-color: var(--surface-color); border-radius: 8px; padding: 40px; box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15); width: 100%; max-width: 500px; box-sizing: border-box; }
        #role-selection h1 { font-size: 28px; font-weight: 500; margin: 0 0 16px 0; }
        #role-selection p { font-size: 16px; color: var(--text-secondary); margin: 0 0 32px 0; max-width: 400px; }
        .role-buttons { display: flex; flex-direction: column; gap: 16px; width: 100%; max-width: 300px; }
        .role-buttons button { width: 100%; padding: 16px; font-size: 16px; }
        #navrhovatel-view, #navrhovatel-login-view, #navrhovatel-dashboard-view, #zaujemca-view, #detail-view { display: none; width: 100%; max-width: 900px; align-self: flex-start; margin-top: 0; }
        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; width: 100%; }
        .view-header button { width: auto; }
        .view-header span { font-size: 14px; color: var(--text-secondary); }
        .panel { background-color: var(--surface-color); border-radius: 8px; border: 1px solid var(--border-color); box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15); padding: 24px; width: 100%; box-sizing: border-box; }
        h2 { font-size: 22px; font-weight: 500; margin-top: 0; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 16px; }
        h3 { font-size: 18px; font-weight: 500; margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 24px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-grid-tri { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        .form-group { margin: 0; }
        .form-group-full { grid-column: 1 / -1; } 
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: var(--text-secondary); }
        label a.address-map-link { font-size: 12px; margin-left: 8px; float: right; } 
        label span.optional { font-size: 12px; font-weight: 400; color: #9aa0a6; }
        input, select, textarea { width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 16px; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        input[type="file"] { padding: 10px 16px; }
        textarea { resize: vertical; min-height: 80px; }
        input[type="datetime-local"] { font-family: sans-serif; } 
        button { padding: 12px; font-size: 14px; font-weight: 500; border-radius: 8px; cursor: pointer; border: none; }
        button:disabled { background-color: #f1f3f4; color: #bdc1c6; cursor: not-allowed; }
        .btn-primary { background-color: var(--google-blue); color: white; width: 100%; } .btn-primary:not(:disabled):hover { background-color: var(--google-blue-hover); }
        .btn-secondary { background-color: var(--surface-color); color: var(--google-blue); border: 1px solid var(--border-color); width: auto; } .btn-secondary:not(:disabled):hover { background-color: #f8f9fa; }
        #moje-drazby-list .drazba-item { position: relative; padding-bottom: 60px; }
        .drazba-item-actions { position: absolute; bottom: 16px; right: 16px; display: flex; gap: 12px; }
        .drazba-item-actions button { width: auto; padding: 8px 16px; }
        .btn-edit { background-color: var(--warning-color); color: white; }
        .btn-delete { background-color: var(--error-color); color: white; }
        .btn-view { background-color: var(--success-color); color: white; } /* Pre "Sledovať" */
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; }
        .status-planovana { background-color: #e8f0fe; color: var(--google-blue); }
        .status-prebiehajuca { background-color: #e6f4ea; color: var(--success-color); }
        .status-skoncena { background-color: #fce8e6; color: var(--error-color); }
        .status-neuspesna { background-color: #f1f3f4; color: var(--text-secondary); }
        .drazba-item h3 { margin: 0 0 12px 0; color: var(--google-blue); font-size: 18px; }
        .drazba-item-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; font-size: 14px; }
        .drazba-item-grid p { margin: 4px 0; }
        .drazba-item-grid p strong { color: var(--text-primary); }
        .drazba-item-full { grid-column: 1 / -1; }
        .drazba-item .btn-primary { width: auto; padding: 8px 16px; margin-top: 16px; }
        .detail-info h2 { border: none; padding-bottom: 8px; margin-bottom: 16px; font-size: 22px; }
        .detail-info p { font-size: 16px; margin: 8px 0; color: var(--text-secondary); }
        .detail-info p strong { color: var(--text-primary); }
        .detail-info .current-price { font-size: 28px; font-weight: 500; color: var(--google-blue); display: block; margin-top: 16px; }
        .bid-form-grid { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: flex-end; }
        #bid-history-list { list-style-type: none; padding-left: 0; margin-top: 16px; max-height: 200px; overflow-y: auto; border-top: 1px solid var(--border-color); }
        #bid-history-list li { padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        .countdown-display { font-family: 'Roboto Mono', monospace; font-size: 22px; font-weight: 700; color: var(--error-color); background-color: #fce8e6; padding: 16px; border-radius: 8px; text-align: center; margin: 16px 0; }
        .countdown-display.ended { color: var(--text-secondary); background-color: #f1f3f4; font-weight: 500; }
        .licitator-box { font-family: 'Roboto', sans-serif; font-size: 20px; font-weight: 700; color: var(--google-blue); background-color: #e8f0fe; padding: 16px; border-radius: 8px; text-align: center; margin: 16px 0; border: 1px solid var(--google-blue-hover); line-height: 1.5; }
        .licitator-box.final { color: #1e8e3e; background-color: #e6f4ea; border-color: #1e8e3e; font-size: 18px; }
        .licitator-box.no-sale { color: var(--text-secondary); background-color: #f1f3f4; border-color: var(--border-color); font-weight: 500; }
        
        /* <<< NOVÉ: Info pre navrhovateľa v detaile >>> */
        #navrhovatel-info-box {
            background-color: #e8f0fe; color: var(--google-blue);
            padding: 10px 16px; margin-bottom: 20px; border-radius: 4px;
            font-size: 14px; text-align: center;
        }

         @media (max-width: 600px) { 
            body { padding: 8px; gap: 8px;} 
            #role-selection { padding: 20px; margin-top: 20px;} 
            #role-selection h1 { font-size: 24px;} 
            .role-buttons { flex-direction: column; width: 100%;} 
            .role-buttons button { width: 100%; } 
            .panel { padding: 12px; } 
            h2 { font-size: 18px; } 
            .form-grid, .form-grid-tri, .drazba-item-grid { grid-template-columns: 1fr; } 
            .form-group-full { grid-column: 1; } 
         }
    </style>
</head>
<body>

    <div id="role-selection" style="display: flex;"> <h1>Vitajte v E-Dražbe</h1>
        <p>Ste tu, aby ste navrhli novú dražbu, alebo sa chcete zúčastniť ako záujemca?</p>
        <div class="role-buttons">
            <button class="btn-primary" onclick="showNavrhovatelLoginView()">Som Navrhovateľ</button>
            <button class="btn-primary" onclick="showZaujemcaView()">Som Záujemca (kupujúci)</button>
        </div>
    </div>

    <div id="navrhovatel-login-view">
        <div class="view-header"> <button class="btn-secondary" onclick="showRoleSelection()">Späť</button> </div>
        <div class="panel" style="max-width: 500px; margin: 0 auto;">
            <h2>Prihlásenie navrhovateľa</h2>
            <p>Zadajte Vaše údaje, ktorými budete podpisovať Vaše dražby. Týmto sa prihlásite do svojho prehľadu.</p>
            <form id="navrhovatel-login-form" onsubmit="handleNavrhovatelLogin(event)">
                <div class="form-group" style="margin-bottom: 16px;"> <label for="navrhovatelIdDoc">Číslo dokladu (OP):</label> <input type="text" id="navrhovatelIdDoc" required> </div>
                <div class="form-group" style="margin-bottom: 24px;"> <label for="navrhovatelMobil">Mobil (09XXNXXXXX):</label> <input type="tel" id="navrhovatelMobil" placeholder="09XXNXXXXX" required> </div>
                <button type="submit" class="btn-primary">Prihlásiť sa</button> 
            </form>
        </div>
    </div>

    <div id="navrhovatel-dashboard-view">
        <div class="view-header"> 
            <span id="navrhovatel-identita">Načítavam...</span>
            <button class="btn-secondary" onclick="handleNavrhovatelLogout()">Odhlásiť sa</button> 
        </div>
        <div class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Môj prehľad dražieb</h2>
                <button class="btn-primary" onclick="showCreateDrazbaForm()">+ Vytvoriť novú dražbu</button>
            </div>
            <div id="moje-drazby-list" style="margin-top: 24px;"> <p>Načítavam...</p> </div>
        </div>
    </div>

    <div id="navrhovatel-view">
         <div class="view-header"> <button class="btn-secondary" onclick="showNavrhovatelDashboard()">Späť na prehľad</button> </div>
         <div class="panel">
             <h2 id="navrhovatel-form-title">Navrhnúť novú dražbu</h2>
             <form id="drazba-form" onsubmit="handleDrazbaFormSubmit(event)">
                <input type="hidden" id="drazbaIdToEdit" value="">
                <h3>Kontaktná osoba (Licitátor)</h3>
                <p>Tieto údaje slúžia na Vašu identifikáciu a kontaktovanie výhercom. Mobil slúži ako Váš prihlasovací údaj.</p>
                <div class="form-grid-tri">
                    <div class="form-group"> <label for="licitatorMeno">Meno a Priezvisko / Názov:</label> <input type="text" id="licitatorMeno" required> </div>
                    <div class="form-group"> <label for="navrhovatel">Typ navrhovateľa:</label> <select id="navrhovatel" required> <option value="">-- Vyberte --</option><option>Vlastník</option><option>Dražobník</option><option>Exekútor</option><option>Správca</option> </select> </div>
                    <div class="form-group"> <label for="licitatorMobil">Mobil:</label> <input type="tel" id="licitatorMobil" placeholder="09XXNXXXXX" required readonly style="background: #eee;"> </div>
                </div>
                <div class="form-grid-tri" style="margin-top: 16px;">
                    <div class="form-group form-group-full" style="grid-column: 1 / span 2;"> <label for="licitatorAdresa">Adresa: <a href="#" id="licitatorMapLink" target="_blank" class="address-map-link" style="display: none;">(Mapa)</a> </label> <input type="text" id="licitatorAdresa" placeholder="Ulica Číslo, Mesto" required oninput="updateLicitatorMapLink()"> </div>
                    <div class="form-group"> <label for="licitatorEmail">Email: <span class="optional">(nepovinné)</span></label> <input type="email" id="licitatorEmail"> </div>
                </div>
                <h3 style="margin-top: 32px;">Predmet dražby</h3>
                <div class="form-grid">
                    <div class="form-group"> <label for="predmetTyp">Predmet dražby:</label> <select id="predmetTyp" required> <option value="">-- Vyberte --</option><option>Byt</option><option>Rodinný dom</option><option>Pozemok</option><option>Garáž</option><option>Stavba</option><option>Iná nehnuteľnosť</option><option>Vec</option><option>Súbor vecí</option><option>Právo / Súbor práv</option><option>Iná majetková hodnota</option><option>Hromadná vec</option> </select> </div>
                    <div class="form-group"> <label for="okres">Okres:</label> <select id="okres" required> <option value="">-- Vyberte okres --</option> <option>Bánovce nad Bebravou</option><option>Banská Bystrica</option><option>Banská Štiavnica</option><option>Bardejov</option><option>Bratislava I</option><option>Bratislava II</option><option>Bratislava III</option><option>Bratislava IV</option><option>Bratislava V</option><option>Brezno</option><option>Bytča</option><option>Čadca</option><option>Detva</option><option>Dolný Kubín</option><option>Dunajská Streda</option><option>Galanta</option><option>Gelnica</option><option>Hlohovec</option><option>Humenné</option><option>Ilava</option><option>Kežmarok</option><option>Komárno</option><option>Košice I</option><option>Košice II</option><option>Košice III</option><option>Košice IV</option><option>Košice-okolie</option><option>Krupina</option><option>Kysucké Nové Mesto</option><option>Levice</option><option>Levoča</option><option>Liptovský Mikuláš</option><option>Lučenec</option><option>Malacky</option><option>Martin</option><option>Medzilaborce</option><option>Michalovce</option><option>Myjava</option><option>Námestovo</option><option>Nitra</option><option>Nové Mesto nad Váhom</option><option>Nové Zámky</option><option>Partizánske</option><option>Pezinok</option><option>Piešťany</option><option>Poltár</option><option>Poprad</option><option>Považská Bystrica</option><option>Prešov</option><option>Prievidza</option><option>Púchov</option><option>Revúca</option><option>Rimavská Sobota</option><option>Rožňava</option><option>Ružomberok</option><option>Sabinov</option><option>Senec</option><option>Senica</option><option>Skalica</option><option>Snina</option><option>Sobrance</option><option>Spišská Nová Ves</option><option>Stará Ľubovňa</option><option>Stropkov</option><option>Svidník</option><option>Šaľa</option><option>Topoľčany</option><option>Trebišov</option><option>Trenčín</option><option>Trnava</option><option>Turčianske Teplice</option><option>Tvrdošín</option><option>Veľký Krtíš</option><option>Vranov nad Topľou</option><option>Zlaté Moravce</option><option>Zvolen</option><option>Žarnovica</option><option>Žiar nad Hronom</option><option>Žilina</option> </select> </div>
                </div>
                <div class="form-group form-group-full" style="margin-top: 16px;"> <label for="adresa">Adresa predmetu dražby: <a href="#" id="adresaMapLink" target="_blank" class="address-map-link" style="display: none;">(Mapa)</a> </label> <input type="text" id="adresa" placeholder="Ulica Číslo, Mesto" required oninput="updatePredmetMapLink()"> </div>
                <div class="form-group form-group-full" style="margin-top: 16px;"> <label for="predmetDrazby">Opis predmetu:</label> <textarea id="predmetDrazby" placeholder="Podrobný opis nehnuteľnosti, stav, obmedzenia..." required></textarea> </div>
                <div class="form-grid-tri" style="margin-top: 16px;">
                    <div class="form-group"> <label for="obrazokUrl">Odkaz na obrázok: <span class="optional">(nepovinné)</span></label> <input type="url" id="obrazokUrl" placeholder="https://..."> </div>
                    <div class="form-group"> <label for="webOdkaz">Odkaz na web: <span class="optional">(nepovinné)</span></label> <input type="url" id="webOdkaz" placeholder="https://..."> </div>
                    <div class="form-group"> <label for="prilohaLv">List vlastníctva (PDF): <span class="optional">(nepovinné)</span></label> <input type="file" id="prilohaLv" accept=".pdf"> </div>
                </div>
                <h3 style="margin-top: 32px;">Podmienky dražby</h3>
                <div class="form-grid">
                    <div class="form-group"> <label for="najnizsiePodanie">Najnižšie podanie (€):</label> <input type="number" id="najnizsiePodanie" min="0" required> </div>
                    <div class="form-group"> <label for="minimalnePrihodenie">Min. prihodenie (€):</label> <input type="number" id="minimalnePrihodenie" min="1" required> </div>
                    <div class="form-group"> <label for="casZaciatku">Začiatok:</label> <input type="datetime-local" id="casZaciatku" required> </div>
                    <div class="form-group"> <label for="casSkoncenia">Koniec:</label> <input type="datetime-local" id="casSkoncenia" required> </div>
                </div>
                 <button type="submit" id="submitDrazbaButton" class="btn-primary" style="margin-top: 24px; padding: 16px; font-size: 16px;">Vytvoriť dražbu</button>
             </form>
         </div>
    </div>

    <div id="zaujemca-view">
         <div class="view-header"> <button class="btn-secondary" onclick="showRoleSelection()">Zmeniť rolu</button> </div>
         <div class="panel">
              <h2>Prehľad aktuálnych dražieb</h2>
              <div id="drazby-list"> <p>Načítavam...</p> </div>
         </div>
    </div>
    
    <div id="detail-view">
        <div class="view-header"> 
            <button class="btn-secondary" id="detail-back-button" onclick="goBackFromDetail()">Späť</button> 
        </div>
        <div class="panel">
             <div id="navrhovatel-info-box" style="display: none;">Sledujete priebeh Vašej dražby (len na čítanie).</div>
             
             <div id="bidder-login-section" style="margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                 <h2>Identifikácia</h2>
                 <p>Zadajte Vaše údaje pre vstup do tejto dražby.</p>
                 <form id="bidder-login-form" onsubmit="handleBidderLoginSubmit(event)">
                     <input type="hidden" id="loginAuctionId" value=""> 
                     <div class="form-group"> <label for="bidderIdDoc">Číslo dokladu:</label> <input type="text" id="bidderIdDoc" required> </div>
                     <div class="form-group"> <label for="bidderMobile">Mobil (09XXNXXXXX):</label> <input type="tel" id="bidderMobile" placeholder="09XXNXXXXX" required> </div>
                     <div class="form-group"> <label for="bidderMaxBid">Max ponuka (€) (nepov.):</label> <input type="number" id="bidderMaxBid" min="0"></div>
                     <button type="submit" id="bidderLoginSubmitButton" class="btn-primary">Pokračovať k prihodeniu</button> 
                 </form>
             </div>
             
             <div id="bid-section" style="display: none;">
                 <div id="detail-content"> <p>Načítavam...</p> </div>
                 <h2>Prihodenie</h2>
                 <form id="bid-form" onsubmit="handleBidSubmit(event)" data-auction-id="">
                     <div class="bid-form-grid">
                         <div> <label for="bidAmount">Vaša ponuka (€):</label> <input type="number" id="bidAmount" min="0" required> </div>
                         <button type="submit" class="btn-primary" style="width: auto;">Prihodiť</button>
                     </div>
                 </form>
                 <h2>História prihodení</h2>
                 <ul id="bid-history-list"> <li>Načítavam...</li> </ul>
             </div>
        </div>
    </div>

    
    <script>
        console.log("Skript začal.");
        window.onerror = function(msg, src, line, col, err) { console.error("CHYBA JS:", msg, "@", src, `${line}:${col}`, err); try{document.body.innerHTML = `<p style='color:red;'>CHYBA: ${msg}</p>`;}catch(e){} return true; };
        
        const API_URL = 'https://e-drazba-server.onrender.com';
        
        let roleSelectionDiv, navrhovatelViewDiv, zaujemcaViewDiv, detailViewDiv, 
            navrhovatelLoginView, navrhovatelDashboardView,
            drazbyListDiv, drazbaForm, adresaInput, okresSelect, adresaMapLink,
            bidderLoginSection, bidSection;

        let auctionPollInterval = null; 
        let countdownTimerInterval = null; 
        let currentAuctionEndTime = null; 
        let isAutoBidding = false;

        // <<< NOVÉ: Stavová premenná pre detail pohľad >>>
        let currentDetailViewMode = 'zaujemca'; // Môže byť 'zaujemca' alebo 'navrhovatel'
            
        function safeGet(id){ const el = document.getElementById(id); if(!el) throw new Error(`Element #${id} nenájdený!`); return el; }
        
        function validateMobile(mobilRaw) {
            const mobilClean = (mobilRaw || '').replace(/\s/g, ''); 
            if (!/^09\d{8}$/.test(mobilClean)) { return null; }
            return mobilClean; 
        }

        function showView(viewId) {
            console.log(`Prepínam na pohľad: ${viewId}`);
            if (viewId !== 'detail-view') { stopTimers(); }
            const views = [ roleSelectionDiv, navrhovatelViewDiv, zaujemcaViewDiv, detailViewDiv, navrhovatelLoginView, navrhovatelDashboardView ];
            views.forEach(view => { if (view) { view.style.display = (view.id === viewId) ? (viewId === 'role-selection' ? 'flex' : 'block') : 'none'; } });
            document.body.style.alignItems = (viewId === 'role-selection' || viewId === 'navrhovatel-login-view') ? 'center' : 'flex-start';
            if (viewId === 'zaujemca-view') { loadDrazby(); }
            if (viewId === 'navrhovatel-dashboard-view') { loadMojeDrazby(); }
        }

        function showRoleSelection() { showView('role-selection'); }
        function showZaujemcaView() { showView('zaujemca-view'); }
        function showNavrhovatelLoginView() { showView('navrhovatel-login-view'); }
        function showNavrhovatelDashboard() { 
            const mobil = sessionStorage.getItem('navrhovatelMobil');
            if (!mobil) { alert("Prosím, prihláste sa."); showNavrhovatelLoginView(); return; }
            safeGet('navrhovatel-identita').textContent = `Prihlásený ako: ${mobil}`;
            showView('navrhovatel-dashboard-view'); 
        }
        function showCreateDrazbaForm() {
            safeGet('drazba-form').reset(); 
            safeGet('drazbaIdToEdit').value = ''; 
            safeGet('navrhovatel-form-title').textContent = 'Navrhnúť novú dražbu';
            safeGet('submitDrazbaButton').textContent = 'Vytvoriť dražbu';
            const mobil = sessionStorage.getItem('navrhovatelMobil');
            safeGet('licitatorMobil').value = mobil;
            showView('navrhovatel-view');
        }

        function handleNavrhovatelLogin(event) {
            event.preventDefault();
            const docId = safeGet('navrhovatelIdDoc').value.trim().toUpperCase();
            const mobilRaw = safeGet('navrhovatelMobil').value;
            const mobil = validateMobile(mobilRaw);
            if (!mobil) { return alert("Neplatný formát mobilu. Zadajte 10 číslic, napr. 09XXNXXX."); }
            if (!docId) { return alert("Zadajte číslo dokladu."); }
            const navrhovatelId = `NAV-${docId.slice(-4)}-${mobil.slice(-3)}`;
            sessionStorage.setItem('navrhovatelId', navrhovatelId);
            sessionStorage.setItem('navrhovatelMobil', mobil);
            console.log(`Navrhovateľ prihlásený: ${navrhovatelId}, Mobil: ${mobil}`);
            showNavrhovatelDashboard();
        }

        function handleNavrhovatelLogout() {
            sessionStorage.removeItem('navrhovatelId');
            sessionStorage.removeItem('navrhovatelMobil');
            showRoleSelection();
        }

        // <<< ZMENA: loadMojeDrazby pridáva tlačidlo "Sledovať" >>>
        async function loadMojeDrazby() {
            const listDiv = safeGet('moje-drazby-list');
            listDiv.innerHTML = '<p>Načítavam...</p>';
            const myMobil = sessionStorage.getItem('navrhovatelMobil');
            if (!myMobil) { listDiv.innerHTML = '<p>Chyba prihlásenia.</p>'; return; }
            try {
                const r = await fetch(`${API_URL}/api/drazby`, { cache: 'no-cache' });
                if (!r.ok) throw new Error(`Server ${r.status}`);
                const vsetkyDrazby = await r.json();
                const mojeDrazby = vsetkyDrazby.filter(d => d.mobilNavrhovatela === myMobil);
                listDiv.innerHTML = '';
                if (mojeDrazby.length === 0) { listDiv.innerHTML = '<p>Zatiaľ ste nevytvorili žiadne dražby.</p>'; return; }
                mojeDrazby.reverse().forEach(d => {
                    const item = document.createElement('div');
                    item.className = 'drazba-item';
                    const { status, statusClass, statusText } = getAuctionStatus(d.casZaciatku, d.casSkoncenia);
                    const cP = (d.currentPrice ?? d.najnizsiePodanie ?? 0).toLocaleString('sk-SK');
                    let actionsHTML = '';
                    
                    if (status === 'planovana') {
                        actionsHTML = `<button class="btn-edit" onclick="handleEditDrazba('${d._id}')">Upraviť</button> <button class="btn-delete" onclick="handleDeleteDrazba('${d._id}')">Zrušiť</button>`;
                    } else if (status === 'prebiehajuca') {
                        actionsHTML = `<button class="btn-view" onclick="showNavrhovatelReadOnlyDetailView('${d._id}')">Sledovať priebeh</button>`; // <<< NOVÉ TLAČIDLO
                    } else { // skončená
                         actionsHTML = `<button class="btn-secondary" onclick="showNavrhovatelReadOnlyDetailView('${d._id}')">Zobraziť výsledok</button>`; // Aj pre skončené
                    }

                    item.innerHTML = `
                        <h3>${d.predmetTyp || 'Dražba'}: ${d.adresa || 'N/A'}</h3>
                        <p><span class="status-badge ${statusClass}">${statusText}</span></p>
                        <p><strong>Aktuálna cena:</strong> ${cP} €</p>
                        <p><strong>Koniec:</strong> ${new Date(d.casSkoncenia).toLocaleString('sk-SK')}</p>
                        <div class="drazba-item-actions">${actionsHTML}</div>
                    `;
                    listDiv.appendChild(item);
                });
            } catch (error) {
                console.error("Chyba loadMojeDrazby:", error);
                listDiv.innerHTML = `<p style="color: red;">Chyba: ${error.message}</p>`;
            }
        }
        
        async function handleEditDrazba(auctionId) {
            alert("SIMULÁCIA: Načítavam dáta dražby na úpravu...\n\n(V reálnej aplikácii by sa teraz formulár naplnil dátami zo servera. Náš server túto funkciu nepodporuje.)");
        }
        function handleDeleteDrazba(auctionId) {
            const dovod = prompt("Zadajte dôvod zrušenia dražby (povinné):");
            if (dovod && dovod.trim() !== "") {
                alert(`SIMULÁCIA: Dražba ${auctionId} by bola zrušená.\n\nDôvod: ${dovod}\n\n(Toto vyžaduje zmenu na serveri, ktorá nie je implementovaná.)`);
            } else { alert("Zrušenie prerušené, nebol zadaný dôvod."); }
        }
        
        function updateLicitatorMapLink() {
             const adresa = safeGet('licitatorAdresa').value; const link = safeGet('licitatorMapLink');
             if (adresa) { const query = encodeURIComponent(`${adresa}, Slovensko`); link.href = `https://www.google.com/maps/search/?api=1&query=${query}`; link.style.display = 'inline'; } 
             else { link.style.display = 'none'; }
        }
        function updatePredmetMapLink() {
             const adresa = safeGet('adresa').value; const okres = safeGet('okres').value; const link = safeGet('adresaMapLink');
             if (adresa && okres) { const query = encodeURIComponent(`${adresa}, ${okres}, Slovensko`); link.href = `https://www.google.com/maps/search/?api=1&query=${query}`; link.style.display = 'inline'; } 
             else { link.style.display = 'none'; }
        }
        
        function getAuctionStatus(startTime, endTime) {
            const now = new Date().getTime(); const start = new Date(startTime).getTime(); const end = new Date(endTime).getTime();
            if (now < start) { return { status: 'planovana', statusClass: 'status-planovana', statusText: 'Plánovaná' }; } 
            else if (now >= start && now < end) { return { status: 'prebiehajuca', statusClass: 'status-prebiehajuca', statusText: 'Prebieha' }; } 
            else { return { status: 'skoncena', statusClass: 'status-skoncena', statusText: 'Skončená' }; }
        }

        async function loadDrazby() { 
            console.log("LoadDrazby..."); drazbyListDiv = safeGet('drazby-list'); drazbyListDiv.innerHTML = '<p>Načítavam...</p>'; 
            try { 
                const r = await fetch(`${API_URL}/api/drazby`, { cache: 'no-cache' }); 
                if (!r.ok) throw new Error(`Server ${r.status}`); 
                const drazby = await r.json(); 
                drazbyListDiv.innerHTML = ''; 
                if (!Array.isArray(drazby)) throw new Error("Zlý formát."); 
                const aktivneDrazby = drazby.filter(d => getAuctionStatus(d.casZaciatku, d.casSkoncenia).status !== 'skoncena');
                if (aktivneDrazby.length === 0) { drazbyListDiv.innerHTML = '<p>Momentálne neprebiehajú žiadne dražby.</p>'; return; } 
                aktivneDrazby.forEach(d => { 
                    try { 
                        if (!d || !d._id) return; 
                        const item = document.createElement('div'); item.className = 'drazba-item'; 
                        const { status, statusClass, statusText } = getAuctionStatus(d.casZaciatku, d.casSkoncenia);
                        const cP = (d.currentPrice ?? d.najnizsiePodanie ?? 0).toLocaleString('sk-SK'); 
                        const sP = (d.najnizsiePodanie ?? 0).toLocaleString('sk-SK'); 
                        item.innerHTML = `
                            <h3>${d.predmetTyp || 'Dražba'}: ${d.adresa || 'N/A'}</h3>
                            <p><span class="status-badge ${statusClass}">${statusText}</span></p>
                            <div class="drazba-item-grid">
                                <p><strong>Okres:</strong> ${d.okres||'N/A'}</p>
                                <p><strong>Licitátor:</strong> ${d.licitatorMeno||'N/A'}</p>
                                <p><strong>Najnižšie podanie:</strong> ${sP} €</p>
                                <p><strong>Aktuálna cena:</strong> <span style="font-weight: bold; color: var(--google-blue);">${cP} €</span></p>
                            </div>
                            <div class="item-footer" style="margin-top: 16px;">
                                <button class="btn-primary" onclick="showDetailView('${d._id}')">Detail / Prihodiť</button>
                            </div>`; 
                        drazbyListDiv.appendChild(item); 
                    } catch (loopErr) { console.error(`Chyba karty ${d._id}:`, loopErr); } 
                }); 
            } catch (error) { console.error("Chyba loadDrazby:", error); if (drazbyListDiv) drazbyListDiv.innerHTML = `<p style="color: red;">Chyba: ${error.message}</p>`; } 
        } 

        // --- Logika Detailu Dražby ---
        function stopTimers() {
            if (auctionPollInterval) { clearInterval(auctionPollInterval); auctionPollInterval = null; }
            if (countdownTimerInterval) { clearInterval(countdownTimerInterval); countdownTimerInterval = null; }
            currentAuctionEndTime = null; 
            isAutoBidding = false; 
        }
        function startLiveAuctionUpdates(auctionId) {
            console.log("Spúšťam živé aktualizácie...");
            stopTimers(); 
            loadAuctionDetail(auctionId); 
            auctionPollInterval = setInterval(() => {
                console.log("Polling: Načítavam nové dáta...");
                loadAuctionDetail(auctionId, true); 
            }, 7000); 
            countdownTimerInterval = setInterval(updateCountdown, 1000);
        }
        
        // <<< ZMENA: showDetailView pre Záujemcu >>>
        function showDetailView(auctionId) { 
            console.log(`Zobrazujem detail pre ZÁUJEMCU: ${auctionId}`);
            currentDetailViewMode = 'zaujemca'; // <<< Nastavíme mód
            showView('detail-view'); 
            
            // Skryjeme info box pre navrhovateľa
            safeGet('navrhovatel-info-box').style.display = 'none';

            const bidderId = sessionStorage.getItem(`bidderId_${auctionId}`); 
            if (bidderId) {
                console.log(`Nájdené ID ${bidderId}, zobrazujem prihodenie.`);
                safeGet('bidder-login-section').style.display = 'none';
                safeGet('bid-section').style.display = 'block';
                startLiveAuctionUpdates(auctionId);
            } else {
                console.log(`ID nenájdené, zobrazujem login.`);
                safeGet('bidder-login-section').style.display = 'block';
                safeGet('bid-section').style.display = 'none';
                safeGet('loginAuctionId').value = auctionId; 
                safeGet('detail-content').innerHTML = '<p>Prosím, identifikujte sa pre zobrazenie detailov a prihodenie.</p>'; 
                // Vyčistíme históriu, ak by tam bola stará
                safeGet('bid-history-list').innerHTML = '';
            }
        }

        // <<< NOVÉ: showDetailView pre Navrhovateľa (Read-Only) >>>
        function showNavrhovatelReadOnlyDetailView(auctionId) {
            console.log(`Zobrazujem detail pre NAVRHOVATEĽA (read-only): ${auctionId}`);
            currentDetailViewMode = 'navrhovatel'; // <<< Nastavíme mód
            showView('detail-view');

            // Skryjeme obe sekcie záujemcu
            safeGet('bidder-login-section').style.display = 'none';
            safeGet('bid-section').style.display = 'none';
            
            // Zobrazíme info box
            safeGet('navrhovatel-info-box').style.display = 'block';

            // Spustíme živé aktualizácie
            startLiveAuctionUpdates(auctionId);
        }

        // <<< NOVÉ: Dynamické tlačidlo Späť >>>
        function goBackFromDetail() {
            if (currentDetailViewMode === 'navrhovatel') {
                showNavrhovatelDashboard();
            } else {
                showZaujemcaView();
            }
        }
        
        function updateCountdown() {
            const timerElement = document.getElementById('countdown-timer'); 
            if (!currentAuctionEndTime || !timerElement) { return; }
            const now = new Date().getTime();
            const remaining = currentAuctionEndTime - now;
            if (remaining <= 0) {
                console.log("Čas vypršal. Spúšťam proces ukončenia.");
                stopTimers(); 
                timerElement.style.display = 'none';
                
                // Vypneme formulár LEN ak sme v móde záujemcu
                if (currentDetailViewMode === 'zaujemca') {
                    const bidForm = safeGet('bid-form');
                    const bidAmountInput = safeGet('bidAmount');
                    const bidSubmitButton = bidForm.querySelector('button[type="submit"]');
                    if(bidAmountInput) bidAmountInput.disabled = true;
                    if(bidSubmitButton) { bidSubmitButton.disabled = true; bidSubmitButton.textContent = 'Skončené'; }
                }

                const licitatorBox = safeGet('licitator-display');
                licitatorBox.style.display = 'block';
                licitatorBox.className = 'licitator-box';
                licitatorBox.innerHTML = 'Overujem konečný stav dražby...';
                finalizeAuction();
            } else {
                const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
                const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                let timeString = "";
                if (days > 0) timeString += `${days}d `;
                timeString += `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                timerElement.innerHTML = `Do konca: ${timeString}`;
                timerElement.className = 'countdown-display'; 
                timerElement.style.display = 'block';
                const licitatorBox = document.getElementById('licitator-display');
                if (licitatorBox) licitatorBox.style.display = 'none';
            }
        }
        
        async function finalizeAuction() {
            // Potrebujeme ID aukcie, ale bid-form nemusí byť viditeľný (ak sme navrhovateľ)
            // Musíme ho získať inak. Našťastie, máme ho v globálnej premennej? Nie.
            // Najlepšie je predať ho do `startLiveAuctionUpdates` a odtiaľ ďalej. 
            // Zjednodušenie: Načítame ho z URL alebo z nejakého globálneho stavu (teraz z bid-form, aj keď je skrytý)
            let aucId;
            try { aucId = safeGet('bid-form').dataset.auctionId; } catch(e) {}
            if (!aucId) { console.error("Nepodarilo sa získať ID aukcie pre finalizáciu."); return; }
            
            console.log("Finalize: Načítavam posledný stav...");
            try {
                const r = await fetch(`${API_URL}/api/drazby/${aucId}`, { cache: 'no-cache' });
                if (!r.ok) throw new Error(`Server ${r.status}`);
                const d = await r.json();
                startLicitatorCountdown(d);
            } catch (e) {
                console.error("Chyba pri finálnom načítaní:", e);
                safeGet('licitator-display').innerHTML = 'Chyba pri ukončovaní dražby.';
            }
        }

        function startLicitatorCountdown(auctionData) {
            const licitatorBox = safeGet('licitator-display');
            const aucId = auctionData._id;
            if (!auctionData.highestBidder) {
                licitatorBox.className = 'licitator-box no-sale';
                licitatorBox.innerHTML = 'DRAŽBA SKONČENÁ<br>Žiadne podanie nebolo urobené.';
                return;
            }
            const winnerId = auctionData.highestBidder;
            const winnerDisplayId = `ID: ${winnerId.substring(0,2)}...${winnerId.substring(winnerId.length-4)}`;
            setTimeout(() => { licitatorBox.innerHTML = `PO PRVÉ...<br>pre ${winnerDisplayId} za ${(auctionData.currentPrice||0).toLocaleString('sk-SK')} €`; }, 1000);
            setTimeout(() => { licitatorBox.innerHTML = `PO DRUHÉ...<br>pre ${winnerDisplayId} za ${(auctionData.currentPrice||0).toLocaleString('sk-SK')} €`; }, 2500);
            setTimeout(() => { licitatorBox.innerHTML = `PO TRETIE...<br>PRÍKLEP UDNE!`; licitatorBox.className = 'licitator-box final'; }, 4000);
            setTimeout(() => {
                const myId = sessionStorage.getItem(`bidderId_${aucId}`);
                if (winnerId === myId) {
                    const myMobile = sessionStorage.getItem(`bidderMobile_${aucId}`);
                    licitatorBox.innerHTML = `GRATULUJEME, VYHRALI STE!<br>Príklep bol udelený Vám (Mobil: ${myMobile}). Navrhovateľ Vás bude kontaktovať.`;
                } else {
                    licitatorBox.innerHTML = `DRAŽBA SKONČENÁ.<br>Príklep bol udelený vydražiteľovi s ${winnerDisplayId}. Navrhovateľ bol informovaný.`;
                }
            }, 5500); 
        }
        
        async function submitBidInternal(auctionId, amount, bidderId) {
            if (isAutoBidding) { console.log("AUTO-BID: Už prebieha, preskakujem."); return; }
            isAutoBidding = true;
            console.log(`AUTO-BID: Posielam ponuku ${amount} €`);
            const form = safeGet('bid-form');
            const btn = form.querySelector('button[type="submit"]');
            const originalBtnText = btn.textContent;
            btn.disabled = true; btn.textContent = 'Auto-prihodenie...';
            try {
                const r = await fetch(`${API_URL}/api/drazby/${auctionId}/bid`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ amount: amount, bidderId: bidderId }) });
                if (!r.ok) { const err = await r.json(); throw new Error(err.message || 'Chyba servera.'); }
                console.log("AUTO-BID: Prihodenie OK!");
                loadAuctionDetail(auctionId);
            } catch (e) {
                console.error("Chyba auto-bidu:", e.message);
                alert(`Chyba automatického prihodenia: ${e.message}`);
            } finally {
                setTimeout(() => { isAutoBidding = false; console.log("Auto-bid zámok uvoľnený."); }, 2000); 
                if (btn && !btn.textContent.includes('Skončené')) {
                    btn.disabled = false;
                    btn.textContent = originalBtnText;
                }
            }
        }

        async function loadAuctionDetail(auctionId, isRefresh = false) { 
            const cDiv=safeGet('detail-content'); const hList=safeGet('bid-history-list'); 
            // Formulár potrebujeme aj ak sme navrhovateľ (kvôli auctionId)
            const bForm = document.getElementById('bid-form');
            const bInput = document.getElementById('bidAmount');
            
            if (!isRefresh) { cDiv.innerHTML='<p>Načítavam...</p>'; hList.innerHTML=''; }
            
            try { 
                const r=await fetch(`${API_URL}/api/drazby/${auctionId}`, { cache: 'no-cache' }); if(!r.ok) throw new Error(`Server ${r.status}`); 
                const d=await r.json(); 
                
                // Spustíme auto-bid len ak sme v móde záujemcu
                if (currentDetailViewMode === 'zaujemca') {
                    try {
                        const ourBidderId = sessionStorage.getItem(`bidderId_${auctionId}`);
                        const ourMaxBidStr = sessionStorage.getItem(`bidderMaxBid_${auctionId}`);
                        if (ourBidderId && ourMaxBidStr && !isAutoBidding) {
                            const ourMaxBid = Number(ourMaxBidStr);
                            const currentPrice = d.currentPrice || d.najnizsiePodanie;
                            const minNextBid = currentPrice + d.minimalnePrihodenie;
                            if (d.highestBidder !== ourBidderId && ourMaxBid >= minNextBid) {
                                console.log("AUTO-BID: Podmienky splnené, spúšťam prihodenie.");
                                submitBidInternal(auctionId, minNextBid, ourBidderId);
                            }
                        }
                    } catch (e) { console.error("Chyba v spúšťači auto-bidu:", e); }
                }

                currentAuctionEndTime = d.casZaciatku ? new Date(d.casSkoncenia).getTime() : null;
                const opts={dateStyle:'short',timeStyle:'short'}; 
                const start=d.casZaciatku?new Date(d.casZaciatku).toLocaleString('sk-SK',opts):'N/A'; const end=d.casSkoncenia?new Date(d.casSkoncenia).toLocaleString('sk-SK',opts):'N/A'; 
                let hb='Nikto'; if(d.highestBidder&&d.highestBidder.length>4){hb=`ID: ${d.highestBidder.substring(0,2)}...${d.highestBidder.substring(d.highestBidder.length-4)}`;} 
                const webOdkazHTML = d.webOdkaz ? `<p><strong>Detail na webe:</strong> <a href="${d.webOdkaz}" target="_blank">Otvoriť odkaz</a></p>` : '';
                const obrazokHTML = d.obrazokUrl ? `<img src="${d.obrazokUrl}" alt="Predmet dražby" style="width: 100%; max-width: 400px; border-radius: 8px; margin-top: 16px;">` : '';
                
                cDiv.innerHTML=`<div class="detail-info">
                    <h2>${d.predmetTyp || 'Dražba'}: ${d.predmetDrazby||'N/A'}</h2>
                    ${obrazokHTML}
                    <p><strong>Adresa:</strong> ${d.adresa||'N/A'}, ${d.okres||'N/A'}</p>
                    <p><strong>Licitátor:</strong> ${d.licitatorMeno||'N/A'}</p>
                    ${webOdkazHTML}
                    <p style="font-size: 14px; margin-top: 16px;"><strong>Opis:</strong> ${d.predmetDrazby||'Bez opisu.'}</p>
                    <hr>
                    <p><strong>Aktuálna cena:</strong> <span class="current-price">${(d.currentPrice||d.najnizsiePodanie||0).toLocaleString('sk-SK')} €</span></p>
                    <p><strong>Najvyšší prihadzujúci:</strong> ${hb}</p>
                    <div id="countdown-timer" class="countdown-display">Načítavam čas...</div>
                    <div id="licitator-display" class="licitator-box" style="display: none;"></div>
                    <p><strong>Najnižšie podanie:</strong> ${(d.najnizsiePodanie||0).toLocaleString('sk-SK')} €</p>
                    <p><strong>Minimálne prihodenie:</strong> ${(d.minimalnePrihodenie||0).toLocaleString('sk-SK')} €</p>
                    <p><strong>Začiatok:</strong> ${start}</p><p><strong>Koniec:</strong> ${end}</p>
                </div>`; 
                
                // Uložíme ID aukcie do formulára (aj keď je skrytý), aby ho finalizeAuction našla
                if (bForm) bForm.dataset.auctionId = d._id; 
                
                const minBid=(d.currentPrice||d.najnizsiePodanie||0)+(d.minimalnePrihodenie||1); 
                
                // Input pre ponuku aktualizujeme, len ak sme záujemca
                if (currentDetailViewMode === 'zaujemca' && bInput) {
                    if (!isRefresh) {
                        bInput.min=minBid; 
                        bInput.placeholder=`Min. ${minBid.toLocaleString('sk-SK')} €`; 
                        bInput.value=minBid; 
                    } else {
                        bInput.min=minBid;
                        bInput.placeholder=`Min. ${minBid.toLocaleString('sk-SK')} €`; 
                    }
                }

                hList.innerHTML = ''; 
                if(d.bidHistory&&d.bidHistory.length>0){d.bidHistory.reverse().forEach(b=>{const li=document.createElement('li'); const time=b.timestamp?new Date(b.timestamp).toLocaleString('sk-SK',opts):'N/A'; let bDisp='N/A'; if(b.bidderId&&b.bidderId.length>4){bDisp=`ID: ${b.bidderId.substring(0,2)}...${b.bidderId.substring(b.bidderId.length-4)}`;} li.innerHTML=`<strong>${(b.amount||0).toLocaleString('sk-SK')} €</strong> (${bDisp}) - ${time}`; hList.appendChild(li);});} else {hList.innerHTML='<li>Žiadne prihodenia.</li>';} 
                
                updateCountdown();
            } catch(e){
                console.error("Chyba detailu:",e); 
                cDiv.innerHTML=`<p style="color: red;">Chyba: ${e.message}</p>`;
                stopTimers(); 
            } 
        } 
        
        async function handleDrazbaFormSubmit(event) { 
             event.preventDefault(); 
             const auctionId = safeGet('drazbaIdToEdit').value;
             if (auctionId) { alert(`SIMULÁCIA: Ukladám zmeny pre dražbu ${auctionId}...`); showNavrhovatelDashboard(); return; }
             const btn = safeGet('submitDrazbaButton');
             btn.disabled = true; btn.textContent = 'Vytváram...';
             try {
                 const mobil = validateMobile(safeGet('licitatorMobil').value);
                 if (!mobil) throw new Error("Chyba mobilného čísla licitátora.");
                 const startTime = new Date(safeGet('casZaciatku').value).getTime();
                 const endTime = new Date(safeGet('casSkoncenia').value).getTime();
                 if (endTime <= startTime) { throw new Error("Čas skončenia dražby musí byť neskôr ako čas začiatku."); }
                 const data = {
                     navrhovatel: safeGet('navrhovatel').value, 
                     mobilNavrhovatela: mobil, 
                     licitatorMeno: safeGet('licitatorMeno').value, 
                     licitatorEmail: safeGet('licitatorEmail').value, 
                     licitatorAdresa: safeGet('licitatorAdresa').value, 
                     navrhovatelId: sessionStorage.getItem('navrhovatelId'), 
                     predmetTyp: safeGet('predmetTyp').value, 
                     okres: safeGet('okres').value,
                     adresa: safeGet('adresa').value,
                     predmetDrazby: safeGet('predmetDrazby').value,
                     obrazokUrl: safeGet('obrazokUrl').value, 
                     webOdkaz: safeGet('webOdkaz').value, 
                     najnizsiePodanie: Number(safeGet('najnizsiePodanie').value),
                     minimalnePrihodenie: Number(safeGet('minimalnePrihodenie').value),
                     casZaciatku: safeGet('casZaciatku').value,
                     casSkoncenia: safeGet('casSkoncenia').value,
                 };
                 const r = await fetch(`${API_URL}/api/drazby`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                 if (!r.ok) { 
                     const errData = await r.json(); 
                     let errMsg = errData.message || 'Chyba servera';
                     if (errData.errors) { errMsg = errData.errors.map(e => e.msg).join(', '); }
                     throw new Error(errMsg);
                 }
                 alert('Dražba úspešne vytvorená!');
                 showNavrhovatelDashboard(); 
             } catch (error) {
                 console.error("Chyba pri vytváraní dražby:", error);
                 alert(`Chyba: ${error.message}`);
             } finally {
                 btn.disabled = false; btn.textContent = 'Vytvoriť dražbu';
             }
        }
        
        async function handleBidderLoginSubmit(event) { 
            event.preventDefault(); 
            const docIn=safeGet('bidderIdDoc'); const mobIn=safeGet('bidderMobile'); const aucIdIn=safeGet('loginAuctionId'); const maxIn=safeGet('bidderMaxBid'); const btn=safeGet('bidderLoginSubmitButton'); 
            const docId=docIn.value.trim().toUpperCase(); 
            const mobRaw=mobIn.value.trim(); 
            const mob = validateMobile(mobRaw); 
            const aucId=aucIdIn.value; 
            const maxVal=maxIn.value.trim(); 
            let maxBid=maxVal?Number(maxVal):null; 
            if(!docId||!aucId) return alert("Vyplňte číslo dokladu."); 
            if(!mob) return alert("Mobil musí byť v 10-miestnom formáte, napr. 09XXNXXX.");
            if(maxVal && (maxBid===null || isNaN(maxBid) || maxBid <= 0)) { return alert("Neplatná maximálna ponuka."); }
            const anonDoc=docId.length>4?docId.substring(docId.length-4):docId; const anonMob=mob.length>3?mob.substring(mob.length-3):mob; const bidderId=`ID-${anonDoc}${anonMob}`; 
            btn.disabled=true; btn.textContent='Spracovávam...'; 
            try { 
                sessionStorage.setItem(`bidderId_${aucId}`, bidderId); 
                sessionStorage.setItem(`bidderMobile_${aucId}`, mob); 
                console.log(`Bidder ID ${bidderId} a Mobil *** uložené pre ${aucId}.`); 
                if (maxBid !== null && maxBid > 0) {
                    sessionStorage.setItem(`bidderMaxBid_${aucId}`, maxBid);
                    console.log(`Max Bid ${maxBid}€ uložené pre ${aucId}.`);
                } else {
                    sessionStorage.removeItem(`bidderMaxBid_${aucId}`);
                    console.log(`Max Bid nebolo zadané, auto-bid je vypnutý pre ${aucId}.`);
                }
                if (bidderLoginSection) bidderLoginSection.style.display = 'none';
                if (bidSection) bidSection.style.display = 'block';
                startLiveAuctionUpdates(aucId);
            } catch (e) { alert(`Chyba: ${e.message}`); } 
            finally { btn.disabled=false; btn.textContent='Pokračovať k prihodeniu'; }
        } 
        
        async function handleBidSubmit(event) { 
            event.preventDefault(); 
            if (isAutoBidding) { alert("Automatický agent práve prihadzuje, počkajte prosím."); return; }
            const form=event.target; const aucId=form.dataset.auctionId; const amountIn=safeGet('bidAmount'); const btn=form.querySelector('button[type="submit"]'); 
            const amount=Number(amountIn.value); 
            const bidderId = sessionStorage.getItem(`bidderId_${aucId}`); 
            if (!bidderId) { alert("Chyba ID. Skúste sa znova identifikovať."); showZaujemcaView(); return; } 
            btn.disabled=true; btn.textContent='Odosielam...'; 
            try { 
                const r=await fetch(`${API_URL}/api/drazby/${aucId}/bid`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({amount:amount, bidderId:bidderId})}); 
                if(!r.ok){const err=await r.json(); throw new Error(err.message||'Chyba servera.');} 
                alert('Prihodenie OK!'); 
                console.log("Manuálne prihodenie úspešné. Auto-bid agent zostáva aktívny.");
                loadAuctionDetail(aucId);
            } catch (e) { alert(`Chyba: ${e.message}`); } 
            finally { 
                btn.disabled=false; btn.textContent='Prihodiť'; 
            } 
        } 
        
        document.addEventListener('DOMContentLoaded', () => { 
            console.log("DOM načítaný."); 
            try { 
                console.log("Inicializujem pohľady..."); 
                roleSelectionDiv = safeGet('role-selection'); 
                navrhovatelLoginView = safeGet('navrhovatel-login-view');
                navrhovatelDashboardView = safeGet('navrhovatel-dashboard-view');
                navrhovatelViewDiv = safeGet('navrhovatel-view'); 
                zaujemcaViewDiv = safeGet('zaujemca-view'); 
                detailViewDiv = safeGet('detail-view'); 
                bidderLoginSection = safeGet('bidder-login-section');
                bidSection = safeGet('bid-section');
                drazbyListDiv = safeGet('drazby-list'); 
                console.log("Pohľady OK.");
                if (sessionStorage.getItem('navrhovatelMobil')) {
                    console.log("Nájdené prihlásenie navrhovateľa, idem na dashboard...");
                    showNavrhovatelDashboard();
                } else {
                    console.log("Volám showRoleSelection...");
                    showRoleSelection(); 
                }
                console.log("Inicializácia OK."); 
            } catch (error) { 
                console.error("KRITICKÁ CHYBA INIT:", error); 
                document.body.innerHTML = `<p style="color:red;">Chyba inicializácie: ${error.message}</p>`; 
            } 
        }); 
        
        console.log("Skript načítaný.");
    </script>

</body>
</html>
